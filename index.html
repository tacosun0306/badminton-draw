<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾½çƒé…å°ç³»çµ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 15px;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 5px;
        }
        
        .header p {
            font-size: 14px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }

        .card h3 {
            color: #667eea;
            margin-bottom: 12px;
            font-size: 18px;
        }

        .input-group {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
        }

        input[type="text"] {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 16px;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #764ba2;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .players-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 8px;
            margin-top: 10px;
        }

        .player-badge {
            background: #f8f9fa;
            padding: 8px;
            border-radius: 6px;
            border: 2px solid #667eea;
            text-align: center;
            font-size: 14px;
        }

        .status-box {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #ddd;
        }

        .status-item:last-child {
            border-bottom: none;
        }

        .courts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .court {
            background: #f8f9fa;
            border: 3px solid #667eea;
            border-radius: 12px;
            padding: 20px;
        }

        .court.finished {
            border-color: #28a745;
            background: #d4edda;
        }

        .court-title {
            font-size: 20px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 15px;
            text-align: center;
        }

        .court-players {
            margin-bottom: 15px;
        }

        .player-item {
            background: white;
            padding: 10px;
            margin: 5px 0;
            border-radius: 6px;
            border-left: 4px solid #667eea;
        }

        .waiting-player {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 4px 6px;
            border-radius: 4px;
            text-align: center;
            color: #856404;
            font-weight: 500;
            font-size: 12px;
        }
        
        .waiting-player small {
            display: block;
            margin-top: 1px;
            font-size: 10px;
            color: #856404;
        }

        .waiting-player-tag {
            display: inline-block;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 4px;
            box-shadow: 0 2px 6px rgba(40, 167, 69, 0.2);
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; box-shadow: 0 2px 6px rgba(40, 167, 69, 0.2); }
            50% { opacity: 0.7; box-shadow: 0 2px 12px rgba(40, 167, 69, 0.4); }
        }

        .next-round-box {
            background: #d1ecf1;
            border: 2px solid #17a2b8;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            text-align: center;
        }

        .empty-state {
            text-align: center;
            color: #999;
            padding: 20px;
        }

        .hint {
            background: #e7f3ff;
            padding: 10px 15px;
            border-radius: 8px;
            color: #004085;
            font-size: 14px;
            margin-top: 10px;
        }

        .reset-button-container {
            margin-top: 30px;
            padding: 20px;
            text-align: center;
        }

        .btn-reset-large {
            padding: 18px 60px;
            font-size: 20px;
            font-weight: bold;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
        }

        .btn-reset-large:hover {
            background: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(220, 53, 69, 0.4);
        }

        .btn-reset-large:active {
            transform: translateY(0);
        }

        .display-grid {
            display: grid; grid-template-columns: 2fr 1fr; gap: 20px;
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .btn-reset-large {
                width: 100%;
                padding: 20px;
                font-size: 22px;
            }

            .reset-button-container {
                padding: 15px;
            }

            .display-grid {
                grid-template-columns: 1fr; 
            }
        }

        @media (max-width: 480px) {
            .btn-reset-large {
                padding: 22px;
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¸ ç¾½çƒé…å°ç³»çµ±</h1>
            <p>ä¾åˆ°å ´é †åºç™»è¨˜ï¼Œè‡ªå‹•åˆ†é…å ´æ¬¡</p>
        </div>

        <!-- çƒå“¡ç™»è¨˜è¼¸å…¥æ¬„ -->
        <div class="card" style="position: sticky; top: 10px; z-index: 100; background: white; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
            <div style="text-align: center; margin-bottom: 12px; color: #667eea; font-weight: 600; font-size: 16px;">
                <span id="currentPlayerCount">ğŸ‘¥ ç›®å‰å ±åäººæ•¸ 0äºº</span>
            </div>
            <div class="input-group" style="margin-bottom: 0;">
                <input 
                    type="text" 
                    id="playerNameInput" 
                    placeholder="è¼¸å…¥ä½ çš„å§“å" 
                    onkeypress="if(event.key === 'Enter') addPlayer()">
                <button class="btn btn-primary" onclick="addPlayer()">ç™»è¨˜å…¥å ´</button>
            </div>
        </div>

        <!-- ç•¶å‰æ¯”è³½å’Œç­‰å€™å€ -->
        <div id="currentMatch" style="display: none;">
            <div class="display-grid">
                <!-- ç•¶å‰æ¯”è³½ -->
                <div class="card">
                    <h3>ğŸ¯ ç•¶å‰æ¯”è³½</h3>
                    <div class="courts-container" id="courtsContainer"></div>
                </div>
                
                <!-- ç­‰å€™å€ -->
                <div class="card" id="waitingBoxCard" style="display: none;">
                    <h3>â³ ç­‰å€™å€</h3>
                    <div id="waitingPlayers" style="display: grid; gap: 10px;"></div>
                </div>
            </div>
        </div>

        <!-- ç‹€æ…‹é¡¯ç¤ºå’Œçƒå“¡åˆ—è¡¨ -->
        <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px;">
            <!-- ç‹€æ…‹é¡¯ç¤º -->
            <div class="card">
                <h3>ğŸ“Š ç‹€æ…‹</h3>
                <div class="status-box">
                    <div class="status-item">
                        <span>ç›®å‰å·²ç™»è¨˜çƒå“¡ï¼š</span>
                        <strong id="totalPlayers">0</strong>
                    </div>
                    <div class="status-item">
                        <span>ç›®å‰å·²å®Œæˆå ´æ¬¡ï¼š</span>
                        <strong id="finishedMatches">0</strong>
                    </div>
                    <div class="status-item">
                        <span>å ´ä¸Šï¼š</span>
                        <strong id="onCourtCount">0</strong>
                    </div>
                </div>
                <div class="hint" style="margin-top: 10px; font-size: 12px;">
                    ğŸ’¡ æ»¿8äººé–‹å…©å ´<br>å ´ä¸Šç¶­æŒ8äººï¼Œæ¯”è³½çµæŸè‡ªå‹•è¼ªæ›¿
                </div>
            </div>

            <!-- çƒå“¡åˆ—è¡¨ -->
            <div class="card">
                <h3>ğŸ‘¥ å·²ç™»è¨˜çƒå“¡</h3>
                <div id="playersList"></div>
                <!-- å·²åˆªé™¤çƒå“¡å€å¡Šï¼ˆç°éšï¼‰ -->
                <div id="deletedPlayersList" style="margin-top:20px;filter:grayscale(1);opacity:0.7;"></div>
            </div>
        </div>

        <!-- é‡ç½®æŒ‰éˆ• -->
        <div class="reset-button-container">
            <button class="btn-reset-large" onclick="resetGame()">
                æ¯”è³½é‡ç½®
            </button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        // Firebase é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyC5dyhG0SZHqN1_TOyO8OWVSCbSltnEK1I",
            authDomain: "badminton-draw.firebaseapp.com",
            projectId: "badminton-draw",
            storageBucket: "badminton-draw.firebasestorage.app",
            messagingSenderId: "32998421872",
            appId: "1:32998421872:web:3d399ed7fd9eaf9ab24bb5",
            measurementId: "G-GY8824QHW4"
        };

        // åˆå§‹åŒ– Firebase
        let db = null;
        let isFirebaseEnabled = false;
        let unsubscribe = null;
        
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            isFirebaseEnabled = true;
            console.log('âœ… Firebase å·²é€£ç·š');
            startRealtimeSync();
        } catch (error) {
            console.error('âŒ Firebase åˆå§‹åŒ–å¤±æ•—:', error);
            isFirebaseEnabled = false;
        }

        let players = []; // æ‰€æœ‰çƒå“¡
        let playerMatchCount = {}; // è¨˜éŒ„æ¯å€‹çƒå“¡å·²æ‰“çš„å ´æ¬¡
        let nextPlayerIndex = 0; // ä¸‹ä¸€å€‹æŒ‰é †åºä¸Šå ´çš„çƒå“¡ç´¢å¼•
        let currentCourtA = []; // ç•¶å‰çƒå ´Açš„çƒå“¡
        let currentCourtB = []; // ç•¶å‰çƒå ´Bçš„çƒå“¡
        let courtAFinished = false;
        let courtBFinished = false;
        let courtAStarted = false; // Aå ´æ˜¯å¦å·²å•Ÿç”¨é
        let courtBStarted = false; // Bå ´æ˜¯å¦å·²å•Ÿç”¨é
        let finishedMatches = 0;
        let deletedPlayers = {}; // è¨˜éŒ„åˆªé™¤çš„çƒå“¡åŠå…¶ä¸Šå ´æ¬¡æ•¸
        let pairHistory = {}; // è¨˜éŒ„çƒå“¡é…å°æ­·å² {playerA: {playerB: count, playerC: count}}
        let nextPlayers = []; // ä¸‹ä¸€è¼ªè¦ä¸Šå ´çš„4ä½çƒå“¡
        let nextPlayersNeedUpdate = true; // æ˜¯å¦éœ€è¦é‡æ–°è¨ˆç®—æº–å‚™ä¸Šå ´çƒå“¡

        // æ–°å¢ï¼šè¨˜éŒ„æ¯ä½çƒå“¡æœ€è¿‘ä¸€æ¬¡éšŠå‹åå–®
        let lastTeammates = {};

        // æ–°å¢çƒå“¡
        function addPlayer() {
            const input = document.getElementById('playerNameInput');
            let name = input.value.trim();
            // åå­—æ ¼å¼åŒ–ï¼šé¦–å­—å¤§å¯«ã€å…¶é¤˜å°å¯«
            name = name.replace(/\s+/g, '').replace(/[^\u4e00-\u9fa5A-Za-z0-9]/g, '');
            if (name.length > 0) {
                name = name[0].toUpperCase() + name.slice(1);
            }
            // é•·åº¦é™åˆ¶
            if (!name || name.length < 2 || name.length > 8) {
                showInputError('è«‹è¼¸å…¥2~8å­—çš„æœ‰æ•ˆå§“åï¼ˆç¦æ­¢ç‰¹æ®Šå­—å…ƒï¼‰');
                input.focus();
                return;
            }
            // é˜²é‡è¤‡
            if (players.includes(name)) {
                showInputError('æ­¤å§“åå·²ç™»è¨˜ï¼');
                input.value = '';
                input.focus();
                return;
            }
            // äººæ•¸ä¸Šé™
            if (players.length >= 16) {
                showInputError('å·²é”æœ€å¤š16äººï¼Œç„¡æ³•å†ç™»è¨˜ï¼');
                return;
            }
            // ç¦æ­¢ race conditionï¼šè¼¸å…¥æ¡†æš«æ™‚ disabled
            input.disabled = true;
            players.push(name);
            playerMatchCount[name] = 0;
            pairHistory[name] = {};
            input.value = '';
            input.disabled = false;
            input.focus();
            clearInputError();
            updateDisplay();
            saveToFirebase();
            autoStartIfReady();
        }

        // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
        function showInputError(msg) {
            let err = document.getElementById('inputErrorMsg');
            if (!err) {
                err = document.createElement('div');
                err.id = 'inputErrorMsg';
                err.style.color = '#dc3545';
                err.style.fontWeight = 'bold';
                err.style.marginTop = '6px';
                err.style.textAlign = 'center';
                input.parentNode.appendChild(err);
            }
            err.textContent = msg;
        }
        // æ¸…é™¤éŒ¯èª¤è¨Šæ¯
        function clearInputError() {
            const err = document.getElementById('inputErrorMsg');
            if (err) err.remove();
        }

        // è‡ªå‹•é–‹å§‹æ¯”è³½ï¼ˆæ»¿4äººæˆ–8äººï¼‰
        function autoStartIfReady() {
            // å„ªå…ˆæª¢æŸ¥æ˜¯å¦æœ‰å·²çµæŸçš„çƒå ´å¯ä»¥é‡æ–°é–‹å§‹
            if (courtAFinished) {
                autoReplaceCourtA();
                return;
            }
            if (courtBFinished) {
                autoReplaceCourtB();
                return;
            }
            
            // è¨ˆç®—ç›®å‰å ´ä¸Šäººæ•¸å’Œç­‰å€™å€äººæ•¸
            const onCourt = [...currentCourtA, ...currentCourtB].filter(p => p);
            const waiting = players.filter(p => !currentCourtA.includes(p) && !currentCourtB.includes(p));
            
            console.log('è‡ªå‹•æª¢æŸ¥ - ç¸½äººæ•¸:', players.length, 'å ´ä¸Š:', onCourt.length, 'ç­‰å€™:', waiting.length);
            
            // å¦‚æœç•¶å‰æ²’æœ‰æ¯”è³½é€²è¡Œä¸­ï¼Œä¸”è‡³å°‘æœ‰4äºº
            if (currentCourtA.length === 0 && currentCourtB.length === 0) {
                if (players.length >= 4) {
                    console.log('âœ… å•Ÿå‹•ç¬¬ä¸€å ´æ¯”è³½');
                    nextMatch();
                }
            }
            // å¦‚æœAå ´æœ‰æ¯”è³½ä½†Bå ´ç©ºè‘—ï¼Œä¸”ç­‰å€™å€æœ‰4äººä»¥ä¸Š
            else if (currentCourtA.length > 0 && currentCourtB.length === 0 && !courtAFinished) {
                if (waiting.length >= 4) {
                    console.log('âœ… å•Ÿå‹•Bå ´');
                    startCourtB();
                }
            }
        }
        
        // é–‹å§‹Bå ´
        function startCourtB() {
            // è¨ˆç®—ç­‰å€™å€çƒå“¡ï¼ˆä¸åœ¨Aå ´å’ŒBå ´çš„çƒå“¡ï¼‰
            const waiting = players.filter(p => !currentCourtA.includes(p) && !currentCourtB.includes(p));
            
            console.log('é–‹å§‹Bå ´ - ç­‰å€™å€çƒå“¡:', waiting);
            
            if (waiting.length >= 4) {
                // å„ªå…ˆé¸æ“‡æŒ‰é †åºé‚„æ²’ä¸Šéå ´çš„çƒå“¡
                if (nextPlayerIndex < players.length) {
                    const remaining = players.length - nextPlayerIndex;
                    if (remaining >= 4) {
                        currentCourtB = players.slice(nextPlayerIndex, nextPlayerIndex + 4);
                        nextPlayerIndex += 4;
                    } else {
                        // ä¸è¶³4äººå‰‡å¾ç­‰å€™å€é¸æ“‡
                        currentCourtB = waiting.slice(0, 4);
                    }
                } else {
                    // æ‰€æœ‰äººéƒ½ä¸Šéå ´äº†ï¼Œå¾ç­‰å€™å€æŒ‰ä¸Šå ´æ¬¡æ•¸æ’åºé¸æ“‡
                    waiting.sort((a, b) => {
                        const countA = playerMatchCount[a] || 0;
                        const countB = playerMatchCount[b] || 0;
                        if (countA !== countB) return countA - countB;
                        return players.indexOf(a) - players.indexOf(b);
                    });
                    currentCourtB = waiting.slice(0, 4);
                }
                
                currentCourtB.forEach(p => playerMatchCount[p]++);
                courtBStarted = true;
                courtBFinished = false;
                
                console.log('âœ… Bå ´çƒå“¡:', currentCourtB);
                
                displayMatch();
                saveToFirebase();
            }
        }

        // æ›´æ–°é¡¯ç¤º
        function updateDisplay() {
            document.getElementById('totalPlayers').textContent = players.length;
            
            // æ›´æ–°è¼¸å…¥æ¡†ä¸Šæ–¹çš„å ±åäººæ•¸
            const currentPlayerCount = document.getElementById('currentPlayerCount');
            if (currentPlayerCount) {
                currentPlayerCount.textContent = `ğŸ‘¥ ç›®å‰å ±åäººæ•¸ ${players.length}äºº`;
            }
            
            const playersList = document.getElementById('playersList');
            if (players.length > 0) {
                playersList.innerHTML = `
                    <div style="margin-top: 20px;">
                        <strong style="color: #667eea;">å·²ç™»è¨˜çƒå“¡ (${players.length}/16)</strong>
                        <div class="players-list" style="margin-top: 10px;">
                            ${players.map((name, idx) => 
                                `<div class="player-badge" style="display: flex; align-items: center; justify-content: space-between; gap: 6px;">
                                    <span>${idx + 1}. ${name}</span>
                                    <button onclick="deletePlayer('${name}')" title="åˆªé™¤" style="background: #dc3545; color: white; border: none; border-radius: 50%; width: 28px; height: 28px; font-size: 16px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center;">&#10006;</button>
                                </div>`
                            ).join('')}
                        </div>
                    </div>
                `;
            } else {
                playersList.innerHTML = '<div class="empty-state">å°šç„¡çƒå“¡ç™»è¨˜</div>';
            }
            
            // åœ¨ updateDisplay æœ«å°¾æ–°å¢ï¼š
            const deletedList = document.getElementById('deletedPlayersList');
            if (deletedList) {
                if (Object.keys(deletedPlayers).length > 0) {
                    deletedList.innerHTML = `<div style='margin-top:10px;'>
                        <strong style='color:#dc3545;'>å·²åˆªé™¤çƒå“¡</strong>
                        <div style='display:grid;gap:8px;margin-top:8px;'>
                            ${Object.entries(deletedPlayers).map(([name, count]) =>
                                `<div style='background:#f8d7da;padding:8px;border-radius:6px;display:flex;align-items:center;justify-content:space-between;'>
                                    <span>${name}ï¼ˆå·²æ‰“${count}å ´ï¼‰</span>
                                    <button onclick="restorePlayer('${name}')" style='background:#28a745;color:white;border:none;border-radius:6px;padding:2px 10px;font-size:13px;cursor:pointer;'>æ¢å¾©</button>
                                </div>`
                            ).join('')}
                        </div>
                    </div>`;
                } else {
                    deletedList.innerHTML = '';
                }
            }
            
            // ç›´æ¥è¨ˆç®—å·²å®Œæˆå ´æ¬¡
            let finishedCount = 0;
            // ä»¥æ¯ä½çƒå“¡çš„å‡ºè³½æ¬¡æ•¸åŠ ç¸½ï¼Œé™¤ä»¥æ¯å ´äººæ•¸ï¼ˆ4äººä¸€å ´ï¼‰
            const totalMatchCount = Object.values(playerMatchCount).reduce((a, b) => a + b, 0);
            finishedCount = Math.floor(totalMatchCount / 4);
            document.getElementById('finishedMatches').textContent = finishedCount;
        }

        // é–‹å§‹æ¯”è³½
        function startGame() {
            if (players.length < 4) {
                alert('è‡³å°‘éœ€è¦4ä½çƒå“¡æ‰èƒ½é–‹å§‹ï¼');
                return;
            }
            
            nextPlayerIndex = 0;
            finishedMatches = 0;
            players.forEach(p => playerMatchCount[p] = 0);
            
            nextMatch();
        }

        // é–‹å§‹ä¸‹ä¸€å ´æ¯”è³½
        function nextMatch() {
            courtAFinished = false;
            courtBFinished = false;
            currentCourtA = [];
            currentCourtB = [];
            
            // å¦‚æœé‚„æœ‰äººæŒ‰é †åºæ²’ä¸Šå ´éï¼Œå„ªå…ˆæŒ‰é †åºåˆ†é…
            if (nextPlayerIndex < players.length) {
                assignByOrder();
            } else {
                // æ‰€æœ‰äººéƒ½æŒ‰é †åºä¸Šéå ´äº†ï¼Œæ”¹ç”¨äº‚æ•¸é…å°
                assignByRandom();
            }
            
            displayMatch();
            saveToFirebase();
        }

        // æŒ‰é †åºåˆ†é…
        function assignByOrder() {
            const remaining = players.length - nextPlayerIndex;
            
            if (remaining >= 8) {
                // é‚„æœ‰8äººä»¥ä¸Šï¼Œé–‹å…©å ´
                currentCourtA = players.slice(nextPlayerIndex, nextPlayerIndex + 4);
                currentCourtB = players.slice(nextPlayerIndex + 4, nextPlayerIndex + 8);
                courtAStarted = true;
                courtBStarted = true;
                nextPlayerIndex += 8;
            } else if (remaining >= 4) {
                // é‚„æœ‰4-7äººï¼Œé–‹ä¸€å ´
                currentCourtA = players.slice(nextPlayerIndex, nextPlayerIndex + 4);
                courtAStarted = true;
                nextPlayerIndex += 4;
            } else {
                // ä¸è¶³4äººï¼Œæ··åˆäº‚æ•¸é…å°
                assignByRandom();
                return;
            }
            
            // æ›´æ–°å‡ºè³½æ¬¡æ•¸
            currentCourtA.forEach(p => playerMatchCount[p]++);
            currentCourtB.forEach(p => playerMatchCount[p]++);
        }

        // è¨ˆç®—é…å°å¤šæ¨£æ€§åˆ†æ•¸
        function getPairingScore(group) {
            let score = 0;
            for (let i = 0; i < group.length; i++) {
                for (let j = i + 1; j < group.length; j++) {
                    const p1 = group[i];
                    const p2 = group[j];
                    // æ‡²ç½°åˆ†ï¼šè‹¥ä¸Šæ¬¡å·²åŒçµ„ï¼Œé¡å¤–åŠ åˆ†
                    if (lastTeammates[p1] && lastTeammates[p1].includes(p2)) {
                        score += 100; // æœ€è¿‘åŒçµ„æ‡²ç½°åˆ†
                    }
                    // åŸæœ¬é…å°åˆ†æ•¸
                    score += (pairHistory[p1]?.[p2] || 0) * 2; // é…å°æ¬¡æ•¸è¶Šå¤šï¼Œæ‡²ç½°åˆ†è¶Šé«˜
                }
            }
            return score;
        }

        // äº‚æ•¸é…å°ï¼ˆé…å°å¤šæ¨£æ€§æ¼”ç®—æ³•ï¼Œé¿å…é‡è¤‡é…å°ï¼‰
        function assignByRandom() {
            const available = [...players];
            if (available.length < 4) {
                alert('çƒå“¡äººæ•¸ä¸è¶³4äººï¼Œç„¡æ³•é–‹å§‹æ¯”è³½ï¼');
                return;
            }
            
            // å¤šæ¨£æ€§é…å°ï¼šè©¦å¤šçµ„çµ„åˆï¼Œé¸æ“‡é…å°åˆ†æ•¸æœ€ä½çš„çµ„åˆ
            let bestCourtA = null, bestCourtB = null, bestScore = Infinity;
            const attempts = Math.min(100, 50); // å˜—è©¦50-100ç¨®çµ„åˆ
            
            for (let attempt = 0; attempt < attempts; attempt++) {
                const shuffled = [...available].sort(() => Math.random() - 0.5);
                const courtA = shuffled.slice(0, 4);
                const courtB = available.length >= 8 ? shuffled.slice(4, 8) : [];
                
                const scoreA = getPairingScore(courtA);
                const scoreB = courtB.length > 0 ? getPairingScore(courtB) : 0;
                const totalScore = scoreA + scoreB;
                
                if (totalScore < bestScore) {
                    bestScore = totalScore;
                    bestCourtA = courtA;
                    bestCourtB = courtB;
                }
            }
            
            currentCourtA = bestCourtA;
            currentCourtB = bestCourtB;
            courtAStarted = true;
            courtBStarted = currentCourtB.length > 0;
            
            // è¨˜éŒ„é…å°
            recordPairing(currentCourtA);
            recordPairing(currentCourtB);
            
            // æ›´æ–°å‡ºè³½æ¬¡æ•¸
            currentCourtA.forEach(p => playerMatchCount[p]++);
            currentCourtB.forEach(p => playerMatchCount[p]++);
        }
        
        // è¨˜éŒ„é…å°æ­·å²
        function recordPairing(court) {
            if (court.length < 2) return;
            for (let i = 0; i < court.length; i++) {
                for (let j = i + 1; j < court.length; j++) {
                    const p1 = court[i];
                    const p2 = court[j];
                    if (!pairHistory[p1]) pairHistory[p1] = {};
                    if (!pairHistory[p2]) pairHistory[p2] = {};
                    pairHistory[p1][p2] = (pairHistory[p1][p2] || 0) + 1;
                    pairHistory[p2][p1] = (pairHistory[p2][p1] || 0) + 1;
                }
            }
            // è¨˜éŒ„æœ€è¿‘ä¸€æ¬¡éšŠå‹
            court.forEach(p => {
                lastTeammates[p] = court.filter(x => x !== p);
            });
        }

        // é¡¯ç¤ºæ¯”è³½
        function displayMatch() {
            document.getElementById('currentMatch').style.display = 'block';
            
            const court1 = currentCourtA;
            const court2 = currentCourtB;
            
            // é¡¯ç¤ºçƒå ´
            let courtsHTML = '';
            
            // Aå ´ï¼šåªè¦æ›¾ç¶“å•Ÿç”¨éå°±ä¸€ç›´é¡¯ç¤º
            if (courtAStarted) {
                courtsHTML += `
                    <div class="court ${courtAFinished ? 'finished' : ''}">
                        <div class="court-title">ğŸ¸ çƒå ´ A</div>
                        <div class="court-players">
                            ${currentCourtA.length > 0 ? 
                                currentCourtA.map(p => 
                                    `<div class="player-item">${p} (ç¬¬${playerMatchCount[p]}å ´)</div>`
                                ).join('') : 
                                '<div style="text-align: center; color: #999; padding: 20px;">ç­‰å¾…çƒå“¡ä¸­...</div>'
                            }
                        </div>
                        ${!courtAFinished ? 
                            '<button class="btn btn-danger" onclick="finishCourt(\'A\')" style="width: 100%;">æ¯”è³½çµæŸï¼ˆè‡ªå‹•æ›¿è£œï¼‰</button>' : 
                            '<div style="text-align: center; color: #ff9800; font-weight: bold; padding: 10px; background: #fff3e0; border-radius: 5px;">â³ ç­‰å¾…ä¸­ï¼ˆéœ€è¦4åçƒå“¡ï¼‰</div>'
                        }
                    </div>
                `;
            }
            
            // Bå ´ï¼šåªè¦æ›¾ç¶“å•Ÿç”¨éå°±ä¸€ç›´é¡¯ç¤º
            if (courtBStarted) {
                courtsHTML += `
                    <div class="court ${courtBFinished ? 'finished' : ''}">
                        <div class="court-title">ğŸ¸ çƒå ´ B</div>
                        <div class="court-players">
                            ${currentCourtB.length > 0 ? 
                                currentCourtB.map(p => 
                                    `<div class="player-item">${p} (ç¬¬${playerMatchCount[p]}å ´)</div>`
                                ).join('') : 
                                '<div style="text-align: center; color: #999; padding: 20px;">ç­‰å¾…çƒå“¡ä¸­...</div>'
                            }
                        </div>
                        ${!courtBFinished ? 
                            '<button class="btn btn-danger" onclick="finishCourt(\'B\')" style="width: 100%;">æ¯”è³½çµæŸï¼ˆè‡ªå‹•æ›¿è£œï¼‰</button>' : 
                            '<div style="text-align: center; color: #ff9800; font-weight: bold; padding: 10px; background: #fff3e0; border-radius: 5px;">â³ ç­‰å¾…ä¸­ï¼ˆéœ€è¦4åçƒå“¡ï¼‰</div>'
                        }
                    </div>
                `;
            }
            
            document.getElementById('courtsContainer').innerHTML = courtsHTML;
            
            // æ›´æ–°å ´ä¸Šäººæ•¸å’Œç­‰å€™å€
            const onCourt = [...currentCourtA, ...currentCourtB];
            const waiting = players.filter(p => !onCourt.includes(p));
            
            document.getElementById('onCourtCount').textContent = onCourt.length;
            
            // åªåœ¨éœ€è¦æ›´æ–°æ™‚æ‰é‡æ–°è¨ˆç®—ä¸‹ä¸€è¼ªè¦ä¸Šå ´çš„4ä½çƒå“¡ï¼ˆæŒä¹…åŒ–åˆ° localStorageï¼‰
            if (nextPlayersNeedUpdate) {
                if (waiting.length > 0) {
                    // å…ˆå˜—è©¦å¾ localStorage æ¢å¾©
                    const stored = localStorage.getItem('nextPlayers');
                    if (stored) {
                        try {
                            const restored = JSON.parse(stored);
                            // é©—è­‰å­˜å„²çš„çƒå“¡æ˜¯å¦éƒ½é‚„å­˜åœ¨æ–¼æ‰€æœ‰çƒå“¡åˆ—è¡¨ä¸­
                            if (restored.every(p => players.includes(p))) {
                                nextPlayers = restored;
                                console.log('âœ… å¾ localStorage æ¢å¾©æº–å‚™ä¸Šå ´çƒå“¡:', nextPlayers);
                                nextPlayersNeedUpdate = false;
                            } else {
                                throw new Error('å­˜å„²çš„çƒå“¡ä¸åœ¨æ‰€æœ‰çƒå“¡åˆ—è¡¨ä¸­');
                            }
                        } catch (e) {
                            // localStorage ç„¡æ•ˆï¼Œé‡æ–°è¨ˆç®—
                            console.log('é‡æ–°è¨ˆç®—æº–å‚™ä¸Šå ´çƒå“¡:', e.message);
                            let pool = waiting.length >= 4 ? waiting : players;
                            let best = null, bestScore = Infinity;
                            for (let i = 0; i < 50; i++) {
                                const shuffled = [...pool].sort(() => Math.random() - 0.5);
                                const candidate = shuffled.slice(0, 4);
                                const score = getPairingScore(candidate);
                                if (score < bestScore) {
                                    bestScore = score;
                                    best = candidate;
                                }
                            }
                            nextPlayers = best || [];
                            localStorage.setItem('nextPlayers', JSON.stringify(nextPlayers));
                            console.log('ğŸ’¾ æº–å‚™ä¸Šå ´çƒå“¡å·²å„²å­˜:', nextPlayers);
                            nextPlayersNeedUpdate = false;
                        }
                    } else {
                        // ç¬¬ä¸€æ¬¡è¨ˆç®—ï¼Œæ²’æœ‰ localStorage å­˜å„²
                        let pool = waiting.length >= 4 ? waiting : players;
                        let best = null, bestScore = Infinity;
                        for (let i = 0; i < 50; i++) {
                            const shuffled = [...pool].sort(() => Math.random() - 0.5);
                            const candidate = shuffled.slice(0, 4);
                            const score = getPairingScore(candidate);
                            if (score < bestScore) {
                                bestScore = score;
                                best = candidate;
                            }
                        }
                        nextPlayers = best || [];
                        localStorage.setItem('nextPlayers', JSON.stringify(nextPlayers));
                        console.log('ğŸ’¾ æº–å‚™ä¸Šå ´çƒå“¡å·²å„²å­˜:', nextPlayers);
                        nextPlayersNeedUpdate = false;
                    }
                } else {
                    // ç­‰å€™å€æ²’äºº
                    nextPlayers = [];
                    localStorage.removeItem('nextPlayers');
                    nextPlayersNeedUpdate = false;
                }
            }
            
            // è‹¥æº–å‚™ä¸Šå ´çƒå“¡ä¸è¶³4äººï¼Œå¾çµæŸæ¯”è³½çƒå“¡ä¸­è£œå……
            if (nextPlayers.length < 4 && nextPlayers.length > 0) {
                const finishedPlayers = onCourt.filter(p => !nextPlayers.includes(p));
                const needed = 4 - nextPlayers.length;
                const shuffledFinished = [...finishedPlayers].sort(() => Math.random() - 0.5);
                const replacements = shuffledFinished.slice(0, needed);
                nextPlayers = [...nextPlayers, ...replacements];
                localStorage.setItem('nextPlayers', JSON.stringify(nextPlayers));
                console.log('è£œå……æº–å‚™ä¸Šå ´çƒå“¡:', nextPlayers);
            }
            
            // æ›´æ–°ç­‰å€™å€
            const waitingBoxCard = document.getElementById('waitingBoxCard');
            if (waiting.length > 0) {
                waitingBoxCard.style.display = 'block';
                document.getElementById('waitingPlayers').innerHTML = waiting.map(p => {
                    const isNext = nextPlayers.includes(p);
                    return `<div class="waiting-player">${p}${isNext ? ` <span class="waiting-player-tag" style="cursor:pointer;" onclick="showReplaceDialog('${p}')">æº–å‚™ä¸Šå ´</span>` : ''}<br><small>å·²æ‰“${playerMatchCount[p]}å ´</small></div>`;
                }).join('');
            } else {
                waitingBoxCard.style.display = 'none';
            }
        }

        // æ¨™è¨˜çƒå ´çµæŸä¸¦è‡ªå‹•æ›¿è£œ
        function finishCourt(court) {
            if (court === 'A') {
                courtAFinished = true;
                finishedMatches++;
                document.getElementById('finishedMatches').textContent = finishedMatches;
                localStorage.setItem('finishedMatches', finishedMatches);
                // Aå ´çµæŸï¼Œè‡ªå‹•æ›¿è£œ(æœƒè‡ªå‹•èª¿ç”¨saveToFirebase)
                autoReplaceCourtA();
            } else if (court === 'B') {
                courtBFinished = true;
                finishedMatches++;
                document.getElementById('finishedMatches').textContent = finishedMatches;
                localStorage.setItem('finishedMatches', finishedMatches);
                // Bå ´çµæŸï¼Œè‡ªå‹•æ›¿è£œ(æœƒè‡ªå‹•èª¿ç”¨saveToFirebase)
                autoReplaceCourtB();
            }
        }
        
        // è‡ªå‹•æ›¿è£œAå ´
        function autoReplaceCourtA() {
            console.log('ğŸ”„ Aå ´è‡ªå‹•æ›¿è£œé–‹å§‹');
            console.log('æº–å‚™ä¸Šå ´çƒå“¡:', nextPlayers);
            
            // å„ªå…ˆä½¿ç”¨æº–å‚™ä¸Šå ´çƒå“¡ï¼ˆæ’é™¤æ­£åœ¨Bå ´æ¯”è³½çš„äººï¼‰
            const playingB = courtBFinished || currentCourtB.length === 0 ? [] : currentCourtB;
            let toPlayA = nextPlayers.filter(p => !playingB.includes(p));
            
            // è‹¥æº–å‚™ä¸Šå ´çƒå“¡ä¸è¶³4äººï¼Œå¾å‰›çµæŸçš„Aå ´è£œå……ï¼ˆæ’é™¤æ­£åœ¨Bå ´æ¯”è³½çš„äººï¼‰
            if (toPlayA.length < 4 && currentCourtA.length > 0) {
                const needed = 4 - toPlayA.length;
                const availableFromA = currentCourtA.filter(p => !toPlayA.includes(p) && !playingB.includes(p));
                const shuffledA = [...availableFromA].sort(() => Math.random() - 0.5);
                const supplement = shuffledA.slice(0, needed);
                toPlayA = [...toPlayA, ...supplement];
                console.log('å¾Aå ´è£œå……:', supplement);
            }
            
            // è‹¥ä»ä¸è¶³4äººï¼Œæª¢æŸ¥æ˜¯å¦å¯ä»¥é€²è¡Œæ¯”è³½
            if (toPlayA.length < 4) {
                console.log('âŒ å¯ä¸Šå ´çƒå“¡ä¸è¶³4äººï¼Œä¿æŒAå ´å·²çµæŸç‹€æ…‹');
                currentCourtA = [];
                displayMatch();
                saveToFirebase();
                return;
            }
            
            // å¾toPlayAä¸­éš¨æ©Ÿé¸4äºº
            const selected = [...toPlayA].sort(() => Math.random() - 0.5).slice(0, 4);
            
            console.log('ğŸ² Aå ´ä¸Šå ´çƒå“¡:', selected);
            currentCourtA = selected;
            recordPairing(currentCourtA);
            
            // æ¸…ç©º localStorage ä¸­çš„æº–å‚™ä¸Šå ´çƒå“¡ï¼ˆå› ç‚ºå·²ç¶“ä¸Šå ´äº†ï¼‰
            localStorage.removeItem('nextPlayers');
            nextPlayers = [];
            nextPlayersNeedUpdate = true; // æ¨™è¨˜éœ€è¦é‡æ–°è¨ˆç®—ä¸‹ä¸€è¼ªçƒå“¡
            
            currentCourtA.forEach(p => playerMatchCount[p]++);
            courtAStarted = true;
            courtAFinished = false;
            
            displayMatch();
            saveToFirebase();
        }
        
        // è‡ªå‹•æ›¿è£œBå ´
        function autoReplaceCourtB() {
            console.log('ğŸ”„ Bå ´è‡ªå‹•æ›¿è£œé–‹å§‹');
            console.log('æº–å‚™ä¸Šå ´çƒå“¡:', nextPlayers);
            
            // å„ªå…ˆä½¿ç”¨æº–å‚™ä¸Šå ´çƒå“¡ï¼ˆæ’é™¤æ­£åœ¨Aå ´æ¯”è³½çš„äººï¼‰
            const playingA = courtAFinished || currentCourtA.length === 0 ? [] : currentCourtA;
            let toPlayB = nextPlayers.filter(p => !playingA.includes(p));
            
            // è‹¥æº–å‚™ä¸Šå ´çƒå“¡ä¸è¶³4äººï¼Œå¾å‰›çµæŸçš„Bå ´è£œå……ï¼ˆæ’é™¤æ­£åœ¨Aå ´æ¯”è³½çš„äººï¼‰
            if (toPlayB.length < 4 && currentCourtB.length > 0) {
                const needed = 4 - toPlayB.length;
                const availableFromB = currentCourtB.filter(p => !toPlayB.includes(p) && !playingA.includes(p));
                const shuffledB = [...availableFromB].sort(() => Math.random() - 0.5);
                const supplement = shuffledB.slice(0, needed);
                toPlayB = [...toPlayB, ...supplement];
                console.log('å¾Bå ´è£œå……:', supplement);
            }
            
            // è‹¥ä»ä¸è¶³4äººï¼Œæª¢æŸ¥æ˜¯å¦å¯ä»¥é€²è¡Œæ¯”è³½
            if (toPlayB.length < 4) {
                console.log('âŒ å¯ä¸Šå ´çƒå“¡ä¸è¶³4äººï¼Œä¿æŒBå ´å·²çµæŸç‹€æ…‹');
                currentCourtB = [];
                displayMatch();
                saveToFirebase();
                return;
            }
            
            // å¾toPlayBä¸­éš¨æ©Ÿé¸4äºº
            const selected = [...toPlayB].sort(() => Math.random() - 0.5).slice(0, 4);
            
            console.log('ğŸ² Bå ´ä¸Šå ´çƒå“¡:', selected);
            currentCourtB = selected;
            recordPairing(currentCourtB);
            
            // æ¸…ç©º localStorage ä¸­çš„æº–å‚™ä¸Šå ´çƒå“¡ï¼ˆå› ç‚ºå·²ç¶“ä¸Šå ´äº†ï¼‰
            localStorage.removeItem('nextPlayers');
            nextPlayers = [];
            nextPlayersNeedUpdate = true; // æ¨™è¨˜éœ€è¦é‡æ–°è¨ˆç®—ä¸‹ä¸€è¼ªçƒå“¡
            
            currentCourtB.forEach(p => playerMatchCount[p]++);
            courtBStarted = true;
            courtBFinished = false;
            
            displayMatch();
            saveToFirebase();
        }
        
        // Firebase å³æ™‚åŒæ­¥
        function startRealtimeSync() {
            if (!isFirebaseEnabled) return;
            
            unsubscribe = db.collection('badminton').doc('gameState').onSnapshot((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    players = data.players || [];
                    playerMatchCount = data.playerMatchCount || {};
                    nextPlayerIndex = data.nextPlayerIndex || 0;
                    currentCourtA = data.currentCourtA || [];
                    currentCourtB = data.currentCourtB || [];
                    courtAFinished = data.courtAFinished || false;
                    courtBFinished = data.courtBFinished || false;
                    courtAStarted = data.courtAStarted || false;
                    courtBStarted = data.courtBStarted || false;
                    finishedMatches = data.finishedMatches || 0;
                    nextPlayers = data.nextPlayers || [];
                    deletedPlayers = data.deletedPlayers || {};
                    updateDisplay();
                    
                    // å¦‚æœæœ‰çƒå ´æ­£åœ¨é€²è¡Œï¼Œç«‹å³é¡¯ç¤º
                    if (currentCourtA.length > 0 || currentCourtB.length > 0) {
                        const currentMatchDiv = document.getElementById('currentMatch');
                        if (currentMatchDiv) {
                            currentMatchDiv.style.display = 'block';
                        }
                        displayMatch();
                    }
                    console.log('ğŸ“¡ è³‡æ–™å·²åŒæ­¥');
                }
            }, (error) => {
                console.error('åŒæ­¥éŒ¯èª¤:', error);
            });
        }
        
        // å„²å­˜åˆ° Firebaseï¼ˆnextPlayers ä¹ŸåŒæ­¥ï¼‰
        function saveToFirebase() {
            if (!isFirebaseEnabled) {
                console.log('æœ¬åœ°æ¨¡å¼ï¼šè³‡æ–™å·²æ›´æ–°');
                return;
            }
            const gameState = {
                players,
                playerMatchCount,
                nextPlayerIndex,
                currentCourtA,
                currentCourtB,
                courtAFinished,
                courtBFinished,
                courtAStarted,
                courtBStarted,
                finishedMatches,
                nextPlayers,
                deletedPlayers, // æ–°å¢ deletedPlayers
                lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
            };
            db.collection('badminton').doc('gameState').set(gameState)
                .then(() => console.log('ğŸ’¾ è³‡æ–™å·²å„²å­˜'))
                .catch(error => console.error('å„²å­˜å¤±æ•—:', error));
        }

        // é‡ç½®æ¯”è³½
        function resetGame() {
            if (!confirm('ç¢ºå®šè¦é‡ç½®æ¯”è³½å—ï¼Ÿæ‰€æœ‰è³‡æ–™å°‡æœƒæ¸…ç©ºã€‚')) {
                return;
            }
            
            players = [];
            playerMatchCount = {};
            nextPlayerIndex = 0;
            currentCourtA = [];
            currentCourtB = [];
            courtAFinished = false;
            courtBFinished = false;
            courtAStarted = false;
            courtBStarted = false;
            finishedMatches = 0;
            nextPlayers = [];
            nextPlayersNeedUpdate = true;
            deletedPlayers = {};
            document.getElementById('currentMatch').style.display = 'none';
            document.getElementById('finishedMatches').textContent = '0';
            updateDisplay();
            if (isFirebaseEnabled) {
                saveToFirebase();
            }
        }

        // åˆªé™¤çƒå“¡å‡½å¼
        function deletePlayer(name) {
            // é˜²å‘†ï¼šåˆªé™¤å¾Œäººæ•¸ä¸è¶³4äººç¦æ­¢
            if (players.length <= 4) {
                alert('çƒå“¡äººæ•¸ä½æ–¼4äººï¼Œç„¡æ³•åˆªé™¤ï¼');
                return;
            }
            // é˜²å‘†ï¼šç¦æ­¢åˆªé™¤å ´ä¸Šæ­£åœ¨æ¯”è³½çš„çƒå“¡
            if (currentCourtA.includes(name) || currentCourtB.includes(name)) {
                alert('æ­¤çƒå“¡æ­£åœ¨æ¯”è³½ï¼Œè«‹å…ˆçµæŸæ¯”è³½å†åˆªé™¤ï¼');
                return;
            }
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${name}ã€å—ï¼Ÿ`)) return;
            // è¨˜éŒ„åˆªé™¤å‰çš„ä¸Šå ´æ¬¡æ•¸
            deletedPlayers[name] = playerMatchCount[name] || 0;
            // å¾ players ç§»é™¤
            players = players.filter(p => p !== name);
            // å¾ playerMatchCount ç§»é™¤
            delete playerMatchCount[name];
            // å³æ™‚åŒæ­¥æ•´ç† nextPlayers åå–®
            if (nextPlayers.includes(name)) {
                nextPlayers = nextPlayers.filter(p => p !== name);
                if (nextPlayers.length === 0) {
                    localStorage.removeItem('nextPlayers');
                    nextPlayersNeedUpdate = true;
                } else {
                    localStorage.setItem('nextPlayers', JSON.stringify(nextPlayers));
                }
            }
            // æ›´æ–°é¡¯ç¤ºèˆ‡åŒæ­¥
            updateDisplay();
            saveToFirebase();
        }

        // æ–°å¢ï¼šæ¢å¾©çƒå“¡å‡½å¼
        function restorePlayer(name) {
            if (players.includes(name)) {
                alert('æ­¤çƒå“¡å·²åœ¨åå–®ä¸­ï¼');
                return;
            }
            players.push(name);
            playerMatchCount[name] = deletedPlayers[name];
            delete deletedPlayers[name];
            updateDisplay();
            saveToFirebase();
        }

        // å½ˆå‡ºæ›¿æ›é¸å–®
function showReplaceDialog(oldPlayer) {
    // å–å¾—å¯æ›¿æ›åå–®ï¼ˆç­‰å€™å€ä¸”ä¸åœ¨ nextPlayersï¼‰
    const onCourt = [...currentCourtA, ...currentCourtB];
    const waiting = players.filter(p => !onCourt.includes(p));
    const candidates = waiting.filter(p => !nextPlayers.includes(p));
    if (candidates.length === 0) {
        alert('ç›®å‰æ²’æœ‰å¯æ›¿æ›çš„çƒå“¡');
        return;
    }
    // å»ºç«‹é¸å–®ï¼ˆradio + ç¢ºå®šæŒ‰éˆ•ï¼‰
    const selectHtml = `<div id='replaceDialogBg' style='position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.2);z-index:9999;' onclick='closeReplaceDialog()'></div>
        <div id='replaceDialog' style='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:30px 24px;border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,0.18);z-index:10000;'>
            <div style='font-weight:bold;font-size:18px;margin-bottom:12px;'>æ›¿æ›ã€Œ${oldPlayer}ã€</div>
            <div style='margin-bottom:16px;'>é¸æ“‡è¦æ›¿æ›é€²ä¾†çš„çƒå“¡ï¼š</div>
            <form id='replaceForm'>
                <div style='display:grid;gap:10px;margin-bottom:18px;'>
                    ${candidates.map(p => `<label style='display:flex;align-items:center;gap:8px;'><input type='radio' name='replaceCandidate' value='${p}'><span>${p}</span></label>`).join('')}
                </div>
                <button type='button' onclick="confirmReplaceNextPlayer('${oldPlayer}')" style='padding:10px 28px;border-radius:8px;border:none;background:#28a745;color:white;font-size:16px;cursor:pointer;'>ç¢ºå®š</button>
                <button type='button' onclick='closeReplaceDialog()' style='margin-left:12px;padding:8px 24px;border-radius:8px;border:none;background:#dc3545;color:white;font-size:15px;cursor:pointer;'>å–æ¶ˆ</button>
            </form>
        </div>`;
    const dialog = document.createElement('div');
    dialog.id = 'replaceDialogContainer';
    dialog.innerHTML = selectHtml;
    document.body.appendChild(dialog);
}

function closeReplaceDialog() {
    const dialog = document.getElementById('replaceDialogContainer');
    if (dialog) dialog.remove();
}

// ç¢ºèªæ›¿æ›ï¼ˆé»æ“Šç¢ºå®šæ‰åŸ·è¡Œï¼‰
function confirmReplaceNextPlayer(oldPlayer) {
    const form = document.getElementById('replaceForm');
    if (!form) return;
    const selected = form.querySelector('input[name="replaceCandidate"]:checked');
    if (!selected) {
        alert('è«‹é¸æ“‡è¦æ›¿æ›é€²ä¾†çš„çƒå“¡');
        return;
    }
    const newPlayer = selected.value;
    const idx = nextPlayers.indexOf(oldPlayer);
    if (idx === -1) {
        alert('åŸçƒå“¡ä¸åœ¨æº–å‚™ä¸Šå ´åå–®');
        closeReplaceDialog();
        return;
    }
    // æ›¿æ›å¾Œï¼Œç¢ºä¿ nextPlayers å…§å®¹å”¯ä¸€ä¸”æ­£ç¢º
    nextPlayers[idx] = newPlayer;
    nextPlayers = Array.from(new Set(nextPlayers));
    localStorage.setItem('nextPlayers', JSON.stringify(nextPlayers));
    nextPlayersNeedUpdate = false;
    closeReplaceDialog();
    saveToFirebase(); // æ–°å¢ï¼šåŒæ­¥åˆ° Firebase
    location.reload();
}

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        window.onload = function() {
            // è®€å– finishedMatches
            const storedFinished = localStorage.getItem('finishedMatches');
            if (storedFinished) {
                finishedMatches = parseInt(storedFinished, 10) || 0;
                document.getElementById('finishedMatches').textContent = finishedMatches;
            }
            // deletedPlayers åªèµ° Firebaseï¼Œä¸å†è®€ localStorage
            updateDisplay();
        };
    </script>
</body>
</html>
