<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾½çƒé…å°ç³»çµ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 15px;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 5px;
        }
        
        .header p {
            font-size: 14px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }

        .card h3 {
            color: #667eea;
            margin-bottom: 12px;
            font-size: 18px;
        }

        .input-group {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
        }

        input[type="text"] {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 16px;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #764ba2;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .players-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 8px;
            margin-top: 10px;
        }

        .player-badge {
            background: #f8f9fa;
            padding: 8px;
            border-radius: 6px;
            border: 2px solid #667eea;
            text-align: center;
            font-size: 14px;
        }

        .status-box {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #ddd;
        }

        .status-item:last-child {
            border-bottom: none;
        }

        .courts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .court {
            background: #f8f9fa;
            border: 3px solid #667eea;
            border-radius: 12px;
            padding: 20px;
        }

        .court.finished {
            border-color: #28a745;
            background: #d4edda;
        }

        .court-title {
            font-size: 20px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 15px;
            text-align: center;
        }

        .court-players {
            margin-bottom: 15px;
        }

        .player-item {
            background: white;
            padding: 10px;
            margin: 5px 0;
            border-radius: 6px;
            border-left: 4px solid #667eea;
        }

        .waiting-player {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 4px 6px;
            border-radius: 4px;
            text-align: center;
            color: #856404;
            font-weight: 500;
            font-size: 12px;
            position: relative;
        }
        
        .waiting-player small {
            display: block;
            margin-top: 1px;
            font-size: 10px;
            color: #856404;
        }

        .waiting-player-tag {
            position: absolute;
            top: -8px;
            right: -8px;
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
            animation: blinkTag 1.5s ease-in-out infinite;
            white-space: nowrap;
        }

        @keyframes blinkTag {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.05); }
        }

        .next-round-box {
            background: #d1ecf1;
            border: 2px solid #17a2b8;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            text-align: center;
        }

        .empty-state {
            text-align: center;
            color: #999;
            padding: 20px;
        }

        .hint {
            background: #e7f3ff;
            padding: 10px 15px;
            border-radius: 8px;
            color: #004085;
            font-size: 14px;
            margin-top: 10px;
        }

        .reset-button-container {
            margin-top: 30px;
            padding: 20px;
            text-align: center;
        }

        .btn-reset-large {
            padding: 18px 60px;
            font-size: 20px;
            font-weight: bold;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
        }

        .btn-reset-large:hover {
            background: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(220, 53, 69, 0.4);
        }

        .btn-reset-large:active {
            transform: translateY(0);
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .btn-reset-large {
                width: 100%;
                padding: 20px;
                font-size: 22px;
            }

            .reset-button-container {
                padding: 15px;
            }
        }

        @media (max-width: 480px) {
            .btn-reset-large {
                padding: 22px;
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¸ ç¾½çƒé…å°ç³»çµ±</h1>
            <p>ä¾åˆ°å ´é †åºç™»è¨˜ï¼Œè‡ªå‹•åˆ†é…å ´æ¬¡</p>
        </div>

        <!-- çƒå“¡ç™»è¨˜è¼¸å…¥æ¬„ -->
        <div class="card" style="position: sticky; top: 10px; z-index: 100; background: white; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
            <div style="text-align: center; margin-bottom: 12px; color: #667eea; font-weight: 600; font-size: 16px;">
                <span id="currentPlayerCount">ğŸ‘¥ ç›®å‰å ±åäººæ•¸ 0äºº</span>
            </div>
            <div class="input-group" style="margin-bottom: 0;">
                <input 
                    type="text" 
                    id="playerNameInput" 
                    placeholder="è¼¸å…¥ä½ çš„å§“å" 
                    onkeypress="if(event.key === 'Enter') addPlayer()">
                <button class="btn btn-primary" onclick="addPlayer()">ç™»è¨˜å…¥å ´</button>
            </div>
        </div>

        <!-- ç•¶å‰æ¯”è³½å’Œç­‰å€™å€ -->
        <div id="currentMatch" style="display: none;">
            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px;">
                <!-- ç•¶å‰æ¯”è³½ -->
                <div class="card">
                    <h3>ğŸ¯ ç•¶å‰æ¯”è³½</h3>
                    <div class="courts-container" id="courtsContainer"></div>
                </div>
                
                <!-- ç­‰å€™å€ -->
                <div class="card" id="waitingBoxCard" style="display: none;">
                    <h3>â³ ç­‰å€™å€</h3>
                    <div id="waitingPlayers" style="display: grid; gap: 10px;"></div>
                </div>
            </div>
        </div>

        <!-- ç‹€æ…‹é¡¯ç¤ºå’Œçƒå“¡åˆ—è¡¨ -->
        <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px;">
            <!-- ç‹€æ…‹é¡¯ç¤º -->
            <div class="card">
                <h3>ğŸ“Š ç‹€æ…‹</h3>
                <div class="status-box">
                    <div class="status-item">
                        <span>å·²ç™»è¨˜ï¼š</span>
                        <strong id="totalPlayers">0</strong>
                    </div>
                    <div class="status-item">
                        <span>å·²å®Œæˆï¼š</span>
                        <strong id="finishedMatches">0</strong>
                    </div>
                    <div class="status-item">
                        <span>å ´ä¸Šï¼š</span>
                        <strong id="onCourtCount">0</strong>
                    </div>
                </div>
                <div class="hint" style="margin-top: 10px; font-size: 12px;">
                    ğŸ’¡ æ»¿8äººé–‹å…©å ´<br>å ´ä¸Šç¶­æŒ8äººï¼Œæ¯”è³½çµæŸè‡ªå‹•è¼ªæ›¿
                </div>
            </div>

            <!-- çƒå“¡åˆ—è¡¨ -->
            <div class="card">
                <h3>ğŸ‘¥ å·²ç™»è¨˜çƒå“¡</h3>
                <div id="playersList"></div>
                <!-- å·²åˆªé™¤çƒå“¡å€å¡Šï¼ˆç°éšï¼‰ -->
                <div id="deletedPlayersList" style="margin-top:20px;filter:grayscale(1);opacity:0.7;"></div>
            </div>
        </div>

        <!-- é‡ç½®æŒ‰éˆ• -->
        <div class="reset-button-container">
            <button class="btn-reset-large" onclick="resetGame()">
                æ¯”è³½é‡ç½®
            </button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        // Firebase é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyC5dyhG0SZHqN1_TOyO8OWVSCbSltnEK1I",
            authDomain: "badminton-draw.firebaseapp.com",
            projectId: "badminton-draw",
            storageBucket: "badminton-draw.firebasestorage.app",
            messagingSenderId: "32998421872",
            appId: "1:32998421872:web:3d399ed7fd9eaf9ab24bb5",
            measurementId: "G-GY8824QHW4"
        };

        // åˆå§‹åŒ– Firebase
        let db = null;
        let isFirebaseEnabled = false;
        let unsubscribe = null;
        
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            isFirebaseEnabled = true;
            console.log('âœ… Firebase å·²é€£ç·š');
            startRealtimeSync();
        } catch (error) {
            console.error('âŒ Firebase åˆå§‹åŒ–å¤±æ•—:', error);
            isFirebaseEnabled = false;
        }

        let players = []; // æ‰€æœ‰çƒå“¡
        let playerMatchCount = {}; // è¨˜éŒ„æ¯å€‹çƒå“¡å·²æ‰“çš„å ´æ¬¡
        let nextPlayerIndex = 0; // ä¸‹ä¸€å€‹æŒ‰é †åºä¸Šå ´çš„çƒå“¡ç´¢å¼•
        let currentCourtA = []; // ç•¶å‰çƒå ´Açš„çƒå“¡
        let currentCourtB = []; // ç•¶å‰çƒå ´Bçš„çƒå“¡
        let courtAFinished = false;
        let courtBFinished = false;
        let courtAStarted = false; // Aå ´æ˜¯å¦å·²å•Ÿç”¨é
        let courtBStarted = false; // Bå ´æ˜¯å¦å·²å•Ÿç”¨é
        let finishedMatches = 0;
        let deletedPlayers = {}; // è¨˜éŒ„åˆªé™¤çš„çƒå“¡åŠå…¶ä¸Šå ´æ¬¡æ•¸
        let pairHistory = {}; // è¨˜éŒ„çƒå“¡é…å°æ­·å² {playerA: {playerB: count, playerC: count}}
        let nextAPlayers = []; // ä¸‹ä¸€å ´è¦ä¸Šå ´çš„çƒå“¡

        // æ–°å¢çƒå“¡
        function addPlayer() {
            const input = document.getElementById('playerNameInput');
            const name = input.value.trim();
            
            if (!name) {
                alert('è«‹è¼¸å…¥å§“åï¼');
                return;
            }
            
            if (players.includes(name)) {
                alert('æ­¤å§“åå·²ç™»è¨˜ï¼');
                input.value = '';
                input.focus();
                return;
            }
            
            if (players.length >= 16) {
                alert('å·²é”æœ€å¤š16äººï¼Œç„¡æ³•å†ç™»è¨˜ï¼');
                return;
            }
            
            players.push(name);
            playerMatchCount[name] = 0;
            pairHistory[name] = {};
            input.value = '';
            input.focus();
            updateDisplay();
            saveToFirebase();
            
            // æª¢æŸ¥æ˜¯å¦éœ€è¦è‡ªå‹•é–‹å§‹æ¯”è³½
            autoStartIfReady();
        }

        // è‡ªå‹•é–‹å§‹æ¯”è³½ï¼ˆæ»¿4äººæˆ–8äººï¼‰
        function autoStartIfReady() {
            // å„ªå…ˆæª¢æŸ¥æ˜¯å¦æœ‰å·²çµæŸçš„çƒå ´å¯ä»¥é‡æ–°é–‹å§‹
            if (courtAFinished) {
                autoReplaceCourtA();
                return;
            }
            if (courtBFinished) {
                autoReplaceCourtB();
                return;
            }
            
            // è¨ˆç®—ç›®å‰å ´ä¸Šäººæ•¸å’Œç­‰å€™å€äººæ•¸
            const onCourt = [...currentCourtA, ...currentCourtB].filter(p => p);
            const waiting = players.filter(p => !currentCourtA.includes(p) && !currentCourtB.includes(p));
            
            console.log('è‡ªå‹•æª¢æŸ¥ - ç¸½äººæ•¸:', players.length, 'å ´ä¸Š:', onCourt.length, 'ç­‰å€™:', waiting.length);
            
            // å¦‚æœç•¶å‰æ²’æœ‰æ¯”è³½é€²è¡Œä¸­ï¼Œä¸”è‡³å°‘æœ‰4äºº
            if (currentCourtA.length === 0 && currentCourtB.length === 0) {
                if (players.length >= 4) {
                    console.log('âœ… å•Ÿå‹•ç¬¬ä¸€å ´æ¯”è³½');
                    nextMatch();
                }
            }
            // å¦‚æœAå ´æœ‰æ¯”è³½ä½†Bå ´ç©ºè‘—ï¼Œä¸”ç­‰å€™å€æœ‰4äººä»¥ä¸Š
            else if (currentCourtA.length > 0 && currentCourtB.length === 0 && !courtAFinished) {
                if (waiting.length >= 4) {
                    console.log('âœ… å•Ÿå‹•Bå ´');
                    startCourtB();
                }
            }
        }
        
        // é–‹å§‹Bå ´
        function startCourtB() {
            // è¨ˆç®—ç­‰å€™å€çƒå“¡ï¼ˆä¸åœ¨Aå ´å’ŒBå ´çš„çƒå“¡ï¼‰
            const waiting = players.filter(p => !currentCourtA.includes(p) && !currentCourtB.includes(p));
            
            console.log('é–‹å§‹Bå ´ - ç­‰å€™å€çƒå“¡:', waiting);
            
            if (waiting.length >= 4) {
                // å„ªå…ˆé¸æ“‡æŒ‰é †åºé‚„æ²’ä¸Šéå ´çš„çƒå“¡
                if (nextPlayerIndex < players.length) {
                    const remaining = players.length - nextPlayerIndex;
                    if (remaining >= 4) {
                        currentCourtB = players.slice(nextPlayerIndex, nextPlayerIndex + 4);
                        nextPlayerIndex += 4;
                    } else {
                        // ä¸è¶³4äººå‰‡å¾ç­‰å€™å€é¸æ“‡
                        currentCourtB = waiting.slice(0, 4);
                    }
                } else {
                    // æ‰€æœ‰äººéƒ½ä¸Šéå ´äº†ï¼Œå¾ç­‰å€™å€æŒ‰ä¸Šå ´æ¬¡æ•¸æ’åºé¸æ“‡
                    waiting.sort((a, b) => {
                        const countA = playerMatchCount[a] || 0;
                        const countB = playerMatchCount[b] || 0;
                        if (countA !== countB) return countA - countB;
                        return players.indexOf(a) - players.indexOf(b);
                    });
                    currentCourtB = waiting.slice(0, 4);
                }
                
                currentCourtB.forEach(p => playerMatchCount[p]++);
                courtBStarted = true;
                courtBFinished = false;
                
                console.log('âœ… Bå ´çƒå“¡:', currentCourtB);
                
                displayMatch();
                saveToFirebase();
            }
        }

        // æ›´æ–°é¡¯ç¤º
        function updateDisplay() {
            document.getElementById('totalPlayers').textContent = players.length;
            
            // æ›´æ–°è¼¸å…¥æ¡†ä¸Šæ–¹çš„å ±åäººæ•¸
            const currentPlayerCount = document.getElementById('currentPlayerCount');
            if (currentPlayerCount) {
                currentPlayerCount.textContent = `ğŸ‘¥ ç›®å‰å ±åäººæ•¸ ${players.length}äºº`;
            }
            
            const playersList = document.getElementById('playersList');
            if (players.length > 0) {
                playersList.innerHTML = `
                    <div style="margin-top: 20px;">
                        <strong style="color: #667eea;">å·²ç™»è¨˜çƒå“¡ (${players.length}/16)</strong>
                        <div class="players-list" style="margin-top: 10px;">
                            ${players.map((name, idx) => 
                                `<div class="player-badge" style="display: flex; align-items: center; justify-content: space-between; gap: 6px;">
                                    <span>${idx + 1}. ${name}</span>
                                    <button onclick="deletePlayer('${name}')" title="åˆªé™¤" style="background: #dc3545; color: white; border: none; border-radius: 50%; width: 28px; height: 28px; font-size: 16px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center;">&#10006;</button>
                                </div>`
                            ).join('')}
                        </div>
                    </div>
                `;
            } else {
                playersList.innerHTML = '<div class="empty-state">å°šç„¡çƒå“¡ç™»è¨˜</div>';
            }
            
            // åœ¨ updateDisplay æœ«å°¾æ–°å¢ï¼š
            const deletedList = document.getElementById('deletedPlayersList');
            if (deletedList) {
                if (Object.keys(deletedPlayers).length > 0) {
                    deletedList.innerHTML = `<div style='margin-top:10px;'>
                        <strong style='color:#dc3545;'>å·²åˆªé™¤çƒå“¡</strong>
                        <div style='display:grid;gap:8px;margin-top:8px;'>
                            ${Object.entries(deletedPlayers).map(([name, count]) =>
                                `<div style='background:#f8d7da;padding:8px;border-radius:6px;display:flex;align-items:center;justify-content:space-between;'>
                                    <span>${name}ï¼ˆå·²æ‰“${count}å ´ï¼‰</span>
                                    <button onclick="restorePlayer('${name}')" style='background:#28a745;color:white;border:none;border-radius:6px;padding:2px 10px;font-size:13px;cursor:pointer;'>æ¢å¾©</button>
                                </div>`
                            ).join('')}
                        </div>
                    </div>`;
                } else {
                    deletedList.innerHTML = '';
                }
            }
        }

        // é–‹å§‹æ¯”è³½
        function startGame() {
            if (players.length < 4) {
                alert('è‡³å°‘éœ€è¦4ä½çƒå“¡æ‰èƒ½é–‹å§‹ï¼');
                return;
            }
            
            nextPlayerIndex = 0;
            finishedMatches = 0;
            players.forEach(p => playerMatchCount[p] = 0);
            
            nextMatch();
        }

        // é–‹å§‹ä¸‹ä¸€å ´æ¯”è³½
        function nextMatch() {
            courtAFinished = false;
            courtBFinished = false;
            currentCourtA = [];
            currentCourtB = [];
            
            // å¦‚æœé‚„æœ‰äººæŒ‰é †åºæ²’ä¸Šå ´éï¼Œå„ªå…ˆæŒ‰é †åºåˆ†é…
            if (nextPlayerIndex < players.length) {
                assignByOrder();
            } else {
                // æ‰€æœ‰äººéƒ½æŒ‰é †åºä¸Šéå ´äº†ï¼Œæ”¹ç”¨äº‚æ•¸é…å°
                assignByRandom();
            }
            
            displayMatch();
            saveToFirebase();
        }

        // æŒ‰é †åºåˆ†é…
        function assignByOrder() {
            const remaining = players.length - nextPlayerIndex;
            
            if (remaining >= 8) {
                // é‚„æœ‰8äººä»¥ä¸Šï¼Œé–‹å…©å ´
                currentCourtA = players.slice(nextPlayerIndex, nextPlayerIndex + 4);
                currentCourtB = players.slice(nextPlayerIndex + 4, nextPlayerIndex + 8);
                courtAStarted = true;
                courtBStarted = true;
                nextPlayerIndex += 8;
            } else if (remaining >= 4) {
                // é‚„æœ‰4-7äººï¼Œé–‹ä¸€å ´
                currentCourtA = players.slice(nextPlayerIndex, nextPlayerIndex + 4);
                courtAStarted = true;
                nextPlayerIndex += 4;
            } else {
                // ä¸è¶³4äººï¼Œæ··åˆäº‚æ•¸é…å°
                assignByRandom();
                return;
            }
            
            // æ›´æ–°å‡ºè³½æ¬¡æ•¸
            currentCourtA.forEach(p => playerMatchCount[p]++);
            currentCourtB.forEach(p => playerMatchCount[p]++);
        }

        // è¨ˆç®—é…å°å¤šæ¨£æ€§åˆ†æ•¸
        function getPairingScore(group) {
            let score = 0;
            for (let i = 0; i < group.length; i++) {
                for (let j = i + 1; j < group.length; j++) {
                    const p1 = group[i];
                    const p2 = group[j];
                    score += (pairHistory[p1]?.[p2] || 0);
                }
            }
            return score;
        }

        // äº‚æ•¸é…å°ï¼ˆé…å°å¤šæ¨£æ€§æ¼”ç®—æ³•ï¼Œé¿å…é‡è¤‡é…å°ï¼‰
        function assignByRandom() {
            const available = [...players];
            if (available.length < 4) {
                alert('çƒå“¡äººæ•¸ä¸è¶³4äººï¼Œç„¡æ³•é–‹å§‹æ¯”è³½ï¼');
                return;
            }
            
            // å¤šæ¨£æ€§é…å°ï¼šè©¦å¤šçµ„çµ„åˆï¼Œé¸æ“‡é…å°åˆ†æ•¸æœ€ä½çš„çµ„åˆ
            let bestCourtA = null, bestCourtB = null, bestScore = Infinity;
            const attempts = Math.min(100, 50); // å˜—è©¦50-100ç¨®çµ„åˆ
            
            for (let attempt = 0; attempt < attempts; attempt++) {
                const shuffled = [...available].sort(() => Math.random() - 0.5);
                const courtA = shuffled.slice(0, 4);
                const courtB = available.length >= 8 ? shuffled.slice(4, 8) : [];
                
                const scoreA = getPairingScore(courtA);
                const scoreB = courtB.length > 0 ? getPairingScore(courtB) : 0;
                const totalScore = scoreA + scoreB;
                
                if (totalScore < bestScore) {
                    bestScore = totalScore;
                    bestCourtA = courtA;
                    bestCourtB = courtB;
                }
            }
            
            currentCourtA = bestCourtA;
            currentCourtB = bestCourtB;
            courtAStarted = true;
            courtBStarted = currentCourtB.length > 0;
            
            // è¨˜éŒ„é…å°
            recordPairing(currentCourtA);
            recordPairing(currentCourtB);
            
            // æ›´æ–°å‡ºè³½æ¬¡æ•¸
            currentCourtA.forEach(p => playerMatchCount[p]++);
            currentCourtB.forEach(p => playerMatchCount[p]++);
        }
        
        // è¨˜éŒ„é…å°æ­·å²
        function recordPairing(court) {
            if (court.length < 2) return;
            for (let i = 0; i < court.length; i++) {
                for (let j = i + 1; j < court.length; j++) {
                    const p1 = court[i];
                    const p2 = court[j];
                    if (!pairHistory[p1]) pairHistory[p1] = {};
                    if (!pairHistory[p2]) pairHistory[p2] = {};
                    pairHistory[p1][p2] = (pairHistory[p1][p2] || 0) + 1;
                    pairHistory[p2][p1] = (pairHistory[p2][p1] || 0) + 1;
                }
            }
        }

        // é¡¯ç¤ºæ¯”è³½
        function displayMatch() {
            document.getElementById('currentMatch').style.display = 'block';
            
            const court1 = currentCourtA;
            const court2 = currentCourtB;
            
            // é¡¯ç¤ºçƒå ´
            let courtsHTML = '';
            
            // Aå ´ï¼šåªè¦æ›¾ç¶“å•Ÿç”¨éå°±ä¸€ç›´é¡¯ç¤º
            if (courtAStarted) {
                courtsHTML += `
                    <div class="court ${courtAFinished ? 'finished' : ''}">
                        <div class="court-title">ğŸ¸ çƒå ´ A</div>
                        <div class="court-players">
                            ${currentCourtA.length > 0 ? 
                                currentCourtA.map(p => 
                                    `<div class="player-item">${p} (ç¬¬${playerMatchCount[p]}å ´)</div>`
                                ).join('') : 
                                '<div style="text-align: center; color: #999; padding: 20px;">ç­‰å¾…çƒå“¡ä¸­...</div>'
                            }
                        </div>
                        ${!courtAFinished ? 
                            '<button class="btn btn-success" onclick="finishCourt(\'A\')" style="width: 100%;">æ¯”è³½çµæŸï¼ˆè‡ªå‹•æ›¿è£œï¼‰</button>' : 
                            '<div style="text-align: center; color: #ff9800; font-weight: bold; padding: 10px; background: #fff3e0; border-radius: 5px;">â³ ç­‰å¾…ä¸­ï¼ˆéœ€è¦4åçƒå“¡ï¼‰</div>'
                        }
                    </div>
                `;
            }
            
            // Bå ´ï¼šåªè¦æ›¾ç¶“å•Ÿç”¨éå°±ä¸€ç›´é¡¯ç¤º
            if (courtBStarted) {
                courtsHTML += `
                    <div class="court ${courtBFinished ? 'finished' : ''}">
                        <div class="court-title">ğŸ¸ çƒå ´ B</div>
                        <div class="court-players">
                            ${currentCourtB.length > 0 ? 
                                currentCourtB.map(p => 
                                    `<div class="player-item">${p} (ç¬¬${playerMatchCount[p]}å ´)</div>`
                                ).join('') : 
                                '<div style="text-align: center; color: #999; padding: 20px;">ç­‰å¾…çƒå“¡ä¸­...</div>'
                            }
                        </div>
                        ${!courtBFinished ? 
                            '<button class="btn btn-success" onclick="finishCourt(\'B\')" style="width: 100%;">æ¯”è³½çµæŸï¼ˆè‡ªå‹•æ›¿è£œï¼‰</button>' : 
                            '<div style="text-align: center; color: #ff9800; font-weight: bold; padding: 10px; background: #fff3e0; border-radius: 5px;">â³ ç­‰å¾…ä¸­ï¼ˆéœ€è¦4åçƒå“¡ï¼‰</div>'
                        }
                    </div>
                `;
            }
            
            document.getElementById('courtsContainer').innerHTML = courtsHTML;
            
            // æ›´æ–°å ´ä¸Šäººæ•¸å’Œç­‰å€™å€
            const onCourt = [...currentCourtA, ...currentCourtB];
            const waiting = players.filter(p => !onCourt.includes(p));
            
            document.getElementById('onCourtCount').textContent = onCourt.length;
            
            // é å…ˆå¾ç­‰å€™å€æŠ½é¸ä¸‹ä¸€å ´è¦ä¸Šå ´çš„4äººï¼ˆæ¯æ¬¡åšå®Œä¸€å€‹çµ„åˆå¾Œæ‰æŠ½æ–°çš„ï¼Œé¿å…ç¶“å¸¸è®Šå‹•ï¼‰
            if (waiting.length >= 4 && nextAPlayers.length === 0) {
                // å…ˆå¾ localStorage å˜—è©¦æ¢å¾©
                const stored = localStorage.getItem('nextAPlayers');
                const storedWaiting = localStorage.getItem('nextAPlayersWaiting');
                if (stored && storedWaiting && JSON.parse(storedWaiting) === waiting.length) {
                    try {
                        nextAPlayers = JSON.parse(stored);
                        console.log('âœ… å¾ localStorage æ¢å¾©æº–å‚™ä¸Šå ´çƒå“¡:', nextAPlayers);
                    } catch(e) {
                        nextAPlayers = [];
                    }
                }
                // è‹¥ç„¡æ³•æ¢å¾©æˆ–ç­‰å€™å€äººæ•¸è®Šå‹•ï¼Œæ‰é‡æ–°æŠ½é¸
                if (nextAPlayers.length === 0 || !nextAPlayers.every(p => waiting.includes(p))) {
                    // è©¦50ç¨®çµ„åˆï¼Œé¸æ“‡é…å°åˆ†æ•¸æœ€ä½çš„
                    let bestNext = null, bestScore = Infinity;
                    for (let attempt = 0; attempt < 50; attempt++) {
                        const shuffled = [...waiting].sort(() => Math.random() - 0.5);
                        const candidate = shuffled.slice(0, 4);
                        const score = getPairingScore(candidate);
                        if (score < bestScore) {
                            bestScore = score;
                            bestNext = candidate;
                        }
                    }
                    nextAPlayers = bestNext;
                    // å„²å­˜åˆ° localStorage
                    localStorage.setItem('nextAPlayers', JSON.stringify(nextAPlayers));
                    localStorage.setItem('nextAPlayersWaiting', waiting.length.toString());
                    console.log('ğŸ’¾ æº–å‚™ä¸Šå ´çƒå“¡å·²å„²å­˜:', nextAPlayers);
                }
            } else if (waiting.length < 4) {
                // ç­‰å€™å€ä¸è¶³4äººæ™‚æ¸…ç©º
                nextAPlayers = [];
                localStorage.removeItem('nextAPlayers');
                localStorage.removeItem('nextAPlayersWaiting');
            }
            
            // æ›´æ–°ç­‰å€™å€ï¼ˆç”¨æ¨™ç±¤æ¨™è¨˜ä¸‹ä¸€å ´è¦ä¸Šå ´çš„çƒå“¡ï¼‰
            const waitingBoxCard = document.getElementById('waitingBoxCard');
            if (waiting.length > 0) {
                waitingBoxCard.style.display = 'block';
                document.getElementById('waitingPlayers').innerHTML = waiting.map(p => 
                    `<div class="waiting-player">
                        ${p}
                        ${nextAPlayers.includes(p) ? '<span class="waiting-player-tag">æº–å‚™ä¸Šå ´</span>' : ''}
                        <br><small>å·²æ‰“${playerMatchCount[p]}å ´</small>
                    </div>`
                ).join('');
            } else {
                nextAPlayers = [];
                waitingBoxCard.style.display = 'none';
            }
        }

        // æ¨™è¨˜çƒå ´çµæŸä¸¦è‡ªå‹•æ›¿è£œ
        function finishCourt(court) {
            if (court === 'A') {
                courtAFinished = true;
                finishedMatches++;
                document.getElementById('finishedMatches').textContent = finishedMatches;
                // Aå ´çµæŸï¼Œè‡ªå‹•æ›¿è£œ(æœƒè‡ªå‹•èª¿ç”¨saveToFirebase)
                autoReplaceCourtA();
            } else if (court === 'B') {
                courtBFinished = true;
                finishedMatches++;
                document.getElementById('finishedMatches').textContent = finishedMatches;
                // Bå ´çµæŸï¼Œè‡ªå‹•æ›¿è£œ(æœƒè‡ªå‹•èª¿ç”¨saveToFirebase)
                autoReplaceCourtB();
            }
        }
        
        // è‡ªå‹•æ›¿è£œAå ´
        function autoReplaceCourtA() {
            console.log('ğŸ”„ Aå ´è‡ªå‹•æ›¿è£œé–‹å§‹');
            console.log('æ‰€æœ‰çƒå“¡:', players);
            console.log('Aå ´ç•¶å‰:', currentCourtA);
            console.log('Bå ´ç•¶å‰:', currentCourtB);
            console.log('Bå ´å·²çµæŸ?', courtBFinished);
            
            // è¨ˆç®—ç­‰å€™å€ï¼šæ‰€æœ‰çƒå“¡ - Bå ´æ­£åœ¨æ‰“çš„çƒå“¡ï¼ˆAå ´çƒå“¡å·²è‡ªå‹•æˆç‚ºç­‰å€™å€ï¼‰
            const onCourtB = (courtBFinished || currentCourtB.length === 0) ? [] : currentCourtB;
            console.log('Bå ´åœ¨å ´çƒå“¡:', onCourtB);
            
            let waitingPlayers = players.filter(p => !onCourtB.includes(p));
            console.log('ç­‰å€™å€çƒå“¡ï¼ˆåŒ…å«å‰›çµæŸAå ´çš„4äººï¼‰:', waitingPlayers);
            console.log('çƒå“¡ä¸Šå ´æ¬¡æ•¸:', playerMatchCount);
            
            // æª¢æŸ¥ç­‰å€™å€æ˜¯å¦è‡³å°‘æœ‰4äººå¯ä»¥ä¸Šå ´
            if (waitingPlayers.length < 4) {
                console.log('âŒ ç­‰å€™å€äººæ•¸ä¸è¶³4äººï¼Œä¿æŒAå ´å·²çµæŸç‹€æ…‹');
                currentCourtA = []; // æ¸…ç©ºAå ´
                displayMatch();
                saveToFirebase();
                return;
            }
            
            // å®Œå…¨äº‚æ•¸åˆ†é…ï¼ˆä¸ä¾å‡ºè³½æ¬¡æ•¸ï¼Œåªä»¥äº‚æ•¸ï¼‰
            // ç›´æ¥ä½¿ç”¨ nextAPlayers ä½œç‚ºæ–°Aå ´çƒå“¡
            if (nextAPlayers.length === 0) {
                console.log('âŒ æº–å‚™ä¸Šå ´çƒå“¡ç‚ºç©ºï¼Œç„¡æ³•æ›¿è£œ');
                currentCourtA = [];
                displayMatch();
                saveToFirebase();
                return;
            }
            
            console.log('ğŸ² ä½¿ç”¨æº–å‚™ä¸Šå ´çƒå“¡æ›¿è£œAå ´:', nextAPlayers);
            currentCourtA = nextAPlayers;
            recordPairing(currentCourtA);
            nextAPlayers = []; // æ¸…ç©ºå·²é¸çš„ä¸‹å ´çƒå“¡ï¼Œä¸‹æ¬¡é‡æ–°æŠ½é¸
            localStorage.removeItem('nextAPlayers');
            localStorage.removeItem('nextAPlayersWaiting');
            
            currentCourtA.forEach(p => playerMatchCount[p]++);
            courtAStarted = true;
            courtAFinished = false;
            
            displayMatch();
            saveToFirebase();
        }
        
        // è‡ªå‹•æ›¿è£œBå ´
        function autoReplaceCourtB() {
            console.log('ğŸ”„ Bå ´è‡ªå‹•æ›¿è£œé–‹å§‹');
            console.log('æ‰€æœ‰çƒå“¡:', players);
            console.log('Aå ´ç•¶å‰:', currentCourtA);
            console.log('Bå ´ç•¶å‰:', currentCourtB);
            console.log('Aå ´å·²çµæŸ?', courtAFinished);
            
            // è¨ˆç®—ç­‰å€™å€ï¼šæ‰€æœ‰çƒå“¡ - Aå ´æ­£åœ¨æ‰“çš„çƒå“¡ï¼ˆBå ´çƒå“¡å·²è‡ªå‹•æˆç‚ºç­‰å€™å€ï¼‰
            const onCourtA = (courtAFinished || currentCourtA.length === 0) ? [] : currentCourtA;
            console.log('Aå ´åœ¨å ´çƒå“¡:', onCourtA);
            
            let waitingPlayers = players.filter(p => !onCourtA.includes(p));
            console.log('ç­‰å€™å€çƒå“¡ï¼ˆåŒ…å«å‰›çµæŸBå ´çš„4äººï¼‰:', waitingPlayers);
            console.log('çƒå“¡ä¸Šå ´æ¬¡æ•¸:', playerMatchCount);
            
            // æª¢æŸ¥ç­‰å€™å€æ˜¯å¦è‡³å°‘æœ‰4äººå¯ä»¥ä¸Šå ´
            if (waitingPlayers.length < 4) {
                console.log('âŒ ç­‰å€™å€äººæ•¸ä¸è¶³4äººï¼Œä¿æŒBå ´å·²çµæŸç‹€æ…‹');
                currentCourtB = []; // æ¸…ç©ºBå ´
                displayMatch();
                saveToFirebase();
                return;
            }
            
            // å®Œå…¨äº‚æ•¸åˆ†é…ï¼ˆä¸ä¾å‡ºè³½æ¬¡æ•¸ï¼Œåªä»¥äº‚æ•¸ï¼‰
            // ç›´æ¥ä½¿ç”¨ nextAPlayers ä½œç‚ºæ–°Bå ´çƒå“¡
            if (nextAPlayers.length === 0) {
                console.log('âŒ æº–å‚™ä¸Šå ´çƒå“¡ç‚ºç©ºï¼Œç„¡æ³•æ›¿è£œ');
                currentCourtB = [];
                displayMatch();
                saveToFirebase();
                return;
            }
            
            console.log('ğŸ² ä½¿ç”¨æº–å‚™ä¸Šå ´çƒå“¡æ›¿è£œBå ´:', nextAPlayers);
            currentCourtB = nextAPlayers;
            recordPairing(currentCourtB);
            nextAPlayers = []; // æ¸…ç©ºå·²é¸çš„ä¸‹å ´çƒå“¡ï¼Œä¸‹æ¬¡é‡æ–°æŠ½é¸
            localStorage.removeItem('nextAPlayers');
            localStorage.removeItem('nextAPlayersWaiting');
            
            currentCourtB.forEach(p => playerMatchCount[p]++);
            courtBStarted = true;
            courtBFinished = false;
            
            displayMatch();
            saveToFirebase();
        }
        
        // Firebase å³æ™‚åŒæ­¥
        function startRealtimeSync() {
            if (!isFirebaseEnabled) return;
            
            unsubscribe = db.collection('badminton').doc('gameState').onSnapshot((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    players = data.players || [];
                    playerMatchCount = data.playerMatchCount || {};
                    nextPlayerIndex = data.nextPlayerIndex || 0;
                    currentCourtA = data.currentCourtA || [];
                    currentCourtB = data.currentCourtB || [];
                    courtAFinished = data.courtAFinished || false;
                    courtBFinished = data.courtBFinished || false;
                    courtAStarted = data.courtAStarted || false;
                    courtBStarted = data.courtBStarted || false;
                    finishedMatches = data.finishedMatches || 0;
                    
                    updateDisplay();
                    
                    // å¦‚æœæœ‰çƒå ´æ­£åœ¨é€²è¡Œï¼Œç«‹å³é¡¯ç¤º
                    if (currentCourtA.length > 0 || currentCourtB.length > 0) {
                        const currentMatchDiv = document.getElementById('currentMatch');
                        if (currentMatchDiv) {
                            currentMatchDiv.style.display = 'block';
                        }
                        displayMatch();
                    }
                    console.log('ğŸ“¡ è³‡æ–™å·²åŒæ­¥');
                }
            }, (error) => {
                console.error('åŒæ­¥éŒ¯èª¤:', error);
            });
        }
        
        // å„²å­˜åˆ° Firebase
        function saveToFirebase() {
            if (!isFirebaseEnabled) {
                console.log('æœ¬åœ°æ¨¡å¼ï¼šè³‡æ–™å·²æ›´æ–°');
                return;
            }
            
            const gameState = {
                players,
                playerMatchCount,
                nextPlayerIndex,
                currentCourtA,
                currentCourtB,
                courtAFinished,
                courtBFinished,
                courtAStarted,
                courtBStarted,
                finishedMatches,
                lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            db.collection('badminton').doc('gameState').set(gameState)
                .then(() => console.log('ğŸ’¾ è³‡æ–™å·²å„²å­˜'))
                .catch(error => console.error('å„²å­˜å¤±æ•—:', error));
        }

        // é‡ç½®æ¯”è³½
        function resetGame() {
            if (!confirm('ç¢ºå®šè¦é‡ç½®æ¯”è³½å—ï¼Ÿæ‰€æœ‰è³‡æ–™å°‡æœƒæ¸…ç©ºã€‚')) {
                return;
            }
            
            players = [];
            playerMatchCount = {};
            nextPlayerIndex = 0;
            currentCourtA = [];
            currentCourtB = [];
            courtAFinished = false;
            courtBFinished = false;
            courtAStarted = false;
            courtBStarted = false;
            finishedMatches = 0;
            
            document.getElementById('currentMatch').style.display = 'none';
            document.getElementById('finishedMatches').textContent = '0';
            
            updateDisplay();
            
            if (isFirebaseEnabled) {
                saveToFirebase();
            }
        }

        // åˆªé™¤çƒå“¡å‡½å¼
        function deletePlayer(name) {
            // é˜²å‘†ï¼šåˆªé™¤å¾Œäººæ•¸ä¸è¶³4äººç¦æ­¢
            if (players.length <= 4) {
                alert('çƒå“¡äººæ•¸ä½æ–¼4äººï¼Œç„¡æ³•åˆªé™¤ï¼');
                return;
            }
            // é˜²å‘†ï¼šç¦æ­¢åˆªé™¤å ´ä¸Šæ­£åœ¨æ¯”è³½çš„çƒå“¡
            if (currentCourtA.includes(name) || currentCourtB.includes(name)) {
                alert('æ­¤çƒå“¡æ­£åœ¨æ¯”è³½ï¼Œè«‹å…ˆçµæŸæ¯”è³½å†åˆªé™¤ï¼');
                return;
            }
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${name}ã€å—ï¼Ÿ`)) return;
            // è¨˜éŒ„åˆªé™¤å‰çš„ä¸Šå ´æ¬¡æ•¸
            deletedPlayers[name] = playerMatchCount[name] || 0;
            // å¾ players ç§»é™¤
            players = players.filter(p => p !== name);
            // å¾ playerMatchCount ç§»é™¤
            delete playerMatchCount[name];
            
            // å¦‚æœåˆªé™¤çš„æ˜¯æº–å‚™ä¸Šå ´çƒå“¡ï¼Œè‡ªå‹•æ›¿è£œ
            if (nextAPlayers.includes(name)) {
                console.log('ğŸ—‘ï¸ å·²åˆªé™¤æº–å‚™ä¸Šå ´çƒå“¡:', name);
                nextAPlayers = [];
                localStorage.removeItem('nextAPlayers');
                localStorage.removeItem('nextAPlayersWaiting');
                // é‡æ–°æŠ½é¸ä¸‹ä¸€å ´çƒå“¡
                const onCourt = [...currentCourtA, ...currentCourtB];
                const waiting = players.filter(p => !onCourt.includes(p));
                if (waiting.length >= 4) {
                    let bestNext = null, bestScore = Infinity;
                    for (let attempt = 0; attempt < 50; attempt++) {
                        const shuffled = [...waiting].sort(() => Math.random() - 0.5);
                        const candidate = shuffled.slice(0, 4);
                        const score = getPairingScore(candidate);
                        if (score < bestScore) {
                            bestScore = score;
                            bestNext = candidate;
                        }
                    }
                    nextAPlayers = bestNext;
                    localStorage.setItem('nextAPlayers', JSON.stringify(nextAPlayers));
                    localStorage.setItem('nextAPlayersWaiting', waiting.length.toString());
                    console.log('âœ… è‡ªå‹•è£œä¸Šæ–°çš„æº–å‚™ä¸Šå ´çƒå“¡:', nextAPlayers);
                }
            }
            
            // æ›´æ–°é¡¯ç¤ºèˆ‡åŒæ­¥
            updateDisplay();
            saveToFirebase();
        }

        // æ–°å¢ï¼šæ¢å¾©çƒå“¡å‡½å¼
        function restorePlayer(name) {
            if (players.includes(name)) {
                alert('æ­¤çƒå“¡å·²åœ¨åå–®ä¸­ï¼');
                return;
            }
            players.push(name);
            playerMatchCount[name] = deletedPlayers[name];
            delete deletedPlayers[name];
            updateDisplay();
            saveToFirebase();
        }

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        window.onload = function() {
            updateDisplay();
        };
    </script>
</body>
</html>
