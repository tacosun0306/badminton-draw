<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾½çƒé…å°ç³»çµ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 15px;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 5px;
        }
        
        .header p {
            font-size: 14px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }

        .card h3 {
            color: #667eea;
            margin-bottom: 12px;
            font-size: 18px;
        }

        .input-group {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
        }

        input[type="text"] {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 16px;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #764ba2;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .players-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 8px;
            margin-top: 10px;
        }

        .player-badge {
            background: #f8f9fa;
            padding: 8px;
            border-radius: 6px;
            border: 2px solid #667eea;
            text-align: center;
            font-size: 16px;
        }

        .status-box {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #ddd;
        }

        .status-item:last-child {
            border-bottom: none;
        }

        .courts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .court {
            background: #f8f9fa;
            border: 3px solid #667eea;
            border-radius: 12px;
            padding: 20px;
        }

        .court.finished {
            border-color: #28a745;
            background: #d4edda;
        }

        .court-title {
            font-size: 20px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 15px;
            text-align: center;
        }

        .court-players {
            margin-bottom: 15px;
        }

        .player-item {
            background: white;
            padding: 10px;
            margin: 5px 0;
            border-radius: 6px;
            border-left: 4px solid #667eea;
        }

        .waiting-player {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 4px 6px;
            border-radius: 4px;
            text-align: center;
            color: #856404;
            font-weight: 500;
            font-size: 16px;
        }
        
        .waiting-player small {
            display: block;
            margin-top: 1px;
            font-size: 14px;
            color: #856404;
        }

        .waiting-player-tag {
            display: inline-block;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            margin-left: 4px;
            box-shadow: 0 2px 6px rgba(40, 167, 69, 0.2);
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; box-shadow: 0 2px 6px rgba(40, 167, 69, 0.2); }
            50% { opacity: 0.7; box-shadow: 0 2px 12px rgba(40, 167, 69, 0.4); }
        }

        .next-round-box {
            background: #d1ecf1;
            border: 2px solid #17a2b8;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            text-align: center;
        }

        .empty-state {
            text-align: center;
            color: #999;
            padding: 20px;
        }

        .hint {
            background: #e7f3ff;
            padding: 10px 15px;
            border-radius: 8px;
            color: #004085;
            font-size: 14px;
            margin-top: 10px;
        }

        .reset-button-container {
            margin-top: 30px;
            padding: 20px;
            text-align: center;
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn-reset-large {
            padding: 18px 40px;
            font-size: 18px;
            font-weight: bold;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
            flex: 1;
            min-width: 140px;
        }

        .btn-reset-large:hover {
            background: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(220, 53, 69, 0.4);
        }

        .btn-reset-large:active {
            transform: translateY(0);
        }

        .btn-action-large {
            padding: 18px 40px;
            font-size: 18px;
            font-weight: bold;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            flex: 1;
            min-width: 140px;
        }

        .btn-action-large:hover {
            transform: translateY(-2px);
        }

        .display-grid {
            display: grid; grid-template-columns: 2fr 1fr; gap: 20px;
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .reset-button-container {
                padding: 15px;
                gap: 10px;
            }

            .btn-reset-large, .btn-action-large {
                padding: 14px 20px;
                font-size: 16px;
                min-width: 120px;
            }

            .display-grid {
                grid-template-columns: 1fr; 
            }
        }

        @media (max-width: 480px) {
            .reset-button-container {
                flex-direction: column;
                gap: 8px;
            }

            .btn-reset-large, .btn-action-large {
                width: 100%;
                padding: 16px;
                font-size: 16px;
            }
        }

        /* æ‰‹æ©Ÿç‰ˆæµ®å‹•æ–°å¢çƒå“¡æŒ‰éˆ• */
        .mobile-add-player-btn {
            display: none;
            position: fixed;
            right: 20px;
            top: calc(50% - 30px);
            transform: translateY(-50%);
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: #20c997;
            color: white;
            border: none;
            font-size: 28px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            z-index: 998;
            transition: all 0.3s;
        }

        .mobile-add-player-btn:hover {
            background: #5568d3;
            transform: translateY(-50%) scale(1.1);
        }

        /* æ‰‹æ©Ÿç‰ˆæµ®å‹•å¸¸ç”¨åå–®æŒ‰éˆ• */
        .mobile-favorite-btn {
            display: none;
            position: fixed;
            right: 20px;
            top: calc(50% + 40px);
            transform: translateY(-50%);
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: #17a2b8;
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(23, 162, 184, 0.4);
            z-index: 998;
            transition: all 0.3s;
        }

        .mobile-favorite-btn:hover {
            background: #138496;
            transform: translateY(-50%) scale(1.1);
        }

        .mobile-add-player-panel {
            display: none;
            position: fixed;
            right: 0;
            top: 0;
            bottom: 0;
            width: 100%;
            max-width: 320px;
            background: white;
            box-shadow: -4px 0 20px rgba(0,0,0,0.2);
            z-index: 999;
            padding: 20px;
            transform: translateX(100%);
            transition: transform 0.3s;
            overflow: auto;
        }

        .mobile-add-player-panel.active {
            transform: translateX(0);
        }

        .mobile-favorite-panel {
            display: none;
            position: fixed;
            right: 0;
            top: 0;
            bottom: 0;
            width: 100%;
            max-width: 320px;
            background: white;
            box-shadow: -4px 0 20px rgba(0,0,0,0.2);
            z-index: 999;
            padding: 20px;
            transform: translateX(100%);
            transition: transform 0.3s;
            overflow: auto;
        }

        .mobile-favorite-panel.active {
            transform: translateX(0);
        }

        .mobile-panel-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.3);
            z-index: 998;
        }

        @media (max-width: 768px) {
            .mobile-add-player-btn {
                display: block;
            }

            .mobile-favorite-btn {
                display: block;
            }
            
            .card.desktop-add-player {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¸ ç¾½çƒé…å°ç³»çµ±</h1>
            <p>ä¾åˆ°å ´é †åºç™»è¨˜ï¼Œè‡ªå‹•åˆ†é…å ´æ¬¡</p>
            <div id="syncStatus" style="margin-top:8px;font-size:12px;color:#fff;opacity:0.9;"></div>
        </div>

        <!-- çƒå“¡ç™»è¨˜è¼¸å…¥æ¬„ -->
        <div class="card desktop-add-player" style="position: sticky; top: 10px; z-index: 100; background: white; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
            <div style="text-align: center; margin-bottom: 12px; color: #667eea; font-weight: 600; font-size: 16px;">
                <span id="currentPlayerCount">ğŸ‘¥ ç›®å‰å ±åäººæ•¸ 0äºº</span>
            </div>
            <div class="input-group" style="margin-bottom: 0;">
                <input 
                    type="text" 
                    id="playerNameInput" 
                    placeholder="è¼¸å…¥ä½ çš„å§“å" 
                    onkeypress="if(event.key === 'Enter') addPlayer()">
                <button class="btn btn-primary" onclick="addPlayer()">ç™»è¨˜å…¥å ´</button>
                <button class="btn btn-primary" style="background:#17a2b8;" onclick="toggleFavoriteList()">â­ å¸¸ç”¨</button>
            </div>
            <!-- å¸¸ç”¨åå–® -->
            <div id="favoriteListPanel" style="display:none;margin-top:15px;padding:12px;background:#f0f8ff;border-radius:8px;">
                <div style="margin-bottom:10px;font-weight:bold;color:#667eea;">ğŸ“‹ å¸¸ç”¨åå–®</div>
                <div id="favoritePlayersList" style="display:grid;gap:8px;margin-bottom:10px;"></div>
                <div style="display:flex;gap:8px;">
                    <input type="text" id="newFavoriteName" placeholder="æ–°å¢å¸¸ç”¨çƒå“¡" style="flex:1;padding:8px;border:1px solid #667eea;border-radius:6px;font-size:14px;">
                    <button class="btn btn-success" style="padding:8px 16px;font-size:14px;" onclick="addFavoritePlayer()">æ–°å¢</button>
                </div>
                <div style="display:flex;gap:8px;margin-top:10px;">
                    <button class="btn btn-success" style="flex:1;padding:10px;font-size:14px;font-weight:bold;" onclick="addSelectedFavorites()">âœ“ æ–°å¢å‹¾é¸</button>
                    <button class="btn" style="background:#dc3545;color:white;flex:1;padding:10px;font-size:14px;font-weight:bold;" onclick="toggleFavoriteList()">âœ• é—œé–‰</button>
                </div>
            </div>
        </div>

        <!-- ç•¶å‰æ¯”è³½å’Œç­‰å€™å€ -->
        <div id="currentMatch" style="display: none;">
            <div class="display-grid">
                <!-- ç•¶å‰æ¯”è³½ -->
                <div class="card">
                    <h3>ğŸ¯ ç•¶å‰æ¯”è³½</h3>
                    <div class="courts-container" id="courtsContainer"></div>
                </div>
                
                <!-- ç­‰å€™å€ -->
                <div class="card" id="waitingBoxCard" style="display: none;">
                    <h3>â³ ç­‰å€™å€</h3>
                    <div id="waitingPlayers" style="display: grid; gap: 10px;"></div>
                </div>
            </div>
        </div>

        <!-- ç‹€æ…‹é¡¯ç¤ºå’Œçƒå“¡åˆ—è¡¨ -->
        <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px;">
            <!-- ç‹€æ…‹é¡¯ç¤º -->
            <div class="card">
                <h3>ğŸ“Š ç‹€æ…‹</h3>
                <div class="status-box">
                    <div class="status-item">
                        <span>ç›®å‰å·²ç™»è¨˜çƒå“¡ï¼š</span>
                        <strong id="totalPlayers">0</strong>
                    </div>
                    <div class="status-item">
                        <span>ç›®å‰å·²å®Œæˆå ´æ¬¡ï¼š</span>
                        <strong id="finishedMatches">0</strong>
                    </div>
                    <div class="status-item">
                        <span>å ´ä¸Šï¼š</span>
                        <strong id="onCourtCount">0</strong>
                    </div>
                </div>
                <div class="hint" style="margin-top: 10px; font-size: 12px;">
                    ğŸ’¡ æ»¿8äººé–‹å…©å ´<br>å ´ä¸Šç¶­æŒ8äººï¼Œæ¯”è³½çµæŸè‡ªå‹•è¼ªæ›¿
                </div>
            </div>

            <!-- çƒå“¡åˆ—è¡¨ -->
            <div class="card">
                <h3>ğŸ‘¥ å·²ç™»è¨˜çƒå“¡</h3>
                <div id="playersList"></div>
                <!-- å·²åˆªé™¤çƒå“¡å€å¡Šï¼ˆç°éšï¼‰ -->
                <div id="deletedPlayersList" style="margin-top:20px;filter:grayscale(1);opacity:0.7;"></div>
            </div>
        </div>

        <!-- é…å°çµ±è¨ˆå€å¡Š -->
        <div class="card" id="pairingStats" style="display:none;">
            <h3>ğŸ“Š é…å°çµ±è¨ˆ</h3>
            <div style="display:grid;gap:10px;">
                <div style="background:#e7f3ff;padding:10px;border-radius:6px;">
                    <strong>å‡ºå ´æ¬¡æ•¸çµ±è¨ˆï¼š</strong>
                    <div id="matchCountStats" style="margin-top:8px;font-size:14px;"></div>
                </div>
                <div style="background:#fff3cd;padding:10px;border-radius:6px;">
                    <strong>é…å°å¤šæ¨£æ€§åˆ†æï¼š</strong>
                    <div id="pairingDiversityStats" style="margin-top:8px;font-size:14px;"></div>
                </div>
            </div>
        </div>

        <!-- é‡ç½®æŒ‰éˆ• -->
        <div class="reset-button-container">
            <button class="btn-reset-large" onclick="resetGame()">æ¯”è³½é‡ç½®</button>
            <button class="btn-action-large" style="background:#28a745;color:white;" onclick="saveMatchRecord()">å„²å­˜æ¯”è³½</button>
            <button class="btn-action-large" style="background:#667eea;color:white;" onclick="showMatchCalendar()">æ¯”è³½æ—¥æ›†</button>
        </div>
        <!-- æ¯”è³½ç´€éŒ„å½ˆçª— -->
        <div id="matchRecordModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.18);z-index:9999;">
            <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:32px 28px;border-radius:16px;box-shadow:0 8px 32px rgba(0,0,0,0.18);min-width:340px;max-width:90vw;height: 100vh;
    overflow: auto;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;">
                    <div style="font-size:22px;font-weight:bold;color:#667eea;">æ¯”è³½ç´€éŒ„</div>
                    <button onclick="closeMatchRecordModal()" style="background:transparent;border:none;font-size:28px;color:#999;cursor:pointer;">&times;</button>
                </div>
                <div id="matchRecordTable"></div>
            </div>
        </div>
        <!-- æ¯”è³½æ—¥æ›†å½ˆçª— -->
        <div id="matchCalendarModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.18);z-index:9999;">
            <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:32px 28px;border-radius:16px;box-shadow:0 8px 32px rgba(0,0,0,0.18);min-width:340px;max-width:90vw;height: 100vh;overflow: auto;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;">
                    <div style="font-size:22px;font-weight:bold;color:#667eea;">æ¯”è³½æ—¥æ›†</div>
                    <button onclick="closeMatchCalendarModal()" style="background:transparent;border:none;font-size:28px;color:#999;cursor:pointer;">&times;</button>
                </div>
                <div id="calendarDateList"></div>
                <div id="calendarRecordTable" style="margin-top:18px;"></div>
            </div>
        </div>
    </div>

    <!-- æ‰‹æ©Ÿç‰ˆæµ®å‹•æ–°å¢çƒå“¡æŒ‰éˆ• -->
    <button class="mobile-add-player-btn" onclick="toggleMobilePanel()" title="æ–°å¢çƒå“¡">
        <div style="font-size: 28px; line-height: 1;">+</div>
    </button>

    <!-- æ‰‹æ©Ÿç‰ˆæµ®å‹•å¸¸ç”¨åå–®æŒ‰éˆ• -->
    <button class="mobile-favorite-btn" onclick="toggleMobileFavoritePanel()" title="å¸¸ç”¨åå–®">
        â­
    </button>

    <!-- æ‰‹æ©Ÿç‰ˆæ–°å¢çƒå“¡é¢æ¿ -->
    <div class="mobile-panel-overlay" id="mobilePanelOverlay" onclick="closeMobilePanel()"></div>
    <div class="mobile-add-player-panel" id="mobileAddPlayerPanel">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="margin: 0; color: #667eea;">ğŸ‘¥ æ–°å¢çƒå“¡</h3>
            <button onclick="closeMobilePanel()" style="background: transparent; border: none; font-size: 28px; color: #999; cursor: pointer; padding: 0; width: 32px; height: 32px;">&times;</button>
        </div>
        <div style="text-align: center; margin-bottom: 15px; color: #667eea; font-weight: 600; font-size: 16px;">
            <span id="currentPlayerCountMobile">ğŸ‘¥ ç›®å‰å ±åäººæ•¸ 0äºº</span>
        </div>
        <div style="margin-bottom: 15px;">
            <input 
                type="text" 
                id="playerNameInputMobile" 
                placeholder="è¼¸å…¥ä½ çš„å§“å" 
                style="width: 100%; padding: 12px; border: 2px solid #667eea; border-radius: 8px; font-size: 16px;"
                onkeypress="if(event.key === 'Enter') addPlayerMobile()">
        </div>
        <button class="btn btn-primary" onclick="addPlayerMobile()" style="width: 100%; margin-bottom: 12px;">ç™»è¨˜å…¥å ´</button>
    </div>

    <!-- æ‰‹æ©Ÿç‰ˆå¸¸ç”¨åå–®é¢æ¿ -->
    <div class="mobile-panel-overlay" id="mobileFavoritePanelOverlay" onclick="closeMobileFavoritePanel()"></div>
    <div class="mobile-favorite-panel" id="mobileFavoritePanel">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="margin: 0; color: #17a2b8;">â­ å¸¸ç”¨åå–®</h3>
            <button onclick="closeMobileFavoritePanel()" style="background: transparent; border: none; font-size: 28px; color: #999; cursor: pointer; padding: 0; width: 32px; height: 32px;">&times;</button>
        </div>
        <div style="margin-bottom: 15px;">
            <div style="margin-bottom:10px;font-weight:bold;color:#667eea;font-size:14px;">ğŸ“‹ å¸¸ç”¨çƒå“¡</div>
            <div id="mobileFavoritePlayersList" style="display:grid;gap:6px;margin-bottom:10px;max-height:50vh;overflow-y:auto;"></div>
        </div>
        <div style="display:flex;gap:6px;margin-bottom:12px;">
            <input type="text" id="newFavoriteNameMobile" placeholder="æ–°å¢å¸¸ç”¨çƒå“¡" style="flex:1;padding:12px;border:2px solid #667eea;border-radius:6px;font-size:16px;">
            <button class="btn btn-success" style="padding:12px 16px;font-size:14px;" onclick="addFavoritePlayerMobile()">æ–°å¢</button>
        </div>
        <button class="btn btn-success" style="width:100%;padding:12px;font-weight:bold;font-size:16px;" onclick="addSelectedFavoritesMobile()">âœ“ æ–°å¢å‹¾é¸çš„çƒå“¡</button>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        // Firebase é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyC5dyhG0SZHqN1_TOyO8OWVSCbSltnEK1I",
            authDomain: "badminton-draw.firebaseapp.com",
            projectId: "badminton-draw",
            storageBucket: "badminton-draw.firebasestorage.app",
            messagingSenderId: "32998421872",
            appId: "1:32998421872:web:3d399ed7fd9eaf9ab24bb5",
            measurementId: "G-GY8824QHW4"
        };

        // åˆå§‹åŒ– Firebase
        let db = null;
        let isFirebaseEnabled = false;
        let unsubscribe = null;
        
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            isFirebaseEnabled = true;
            console.log('âœ… Firebase å·²é€£ç·š');
            startRealtimeSync();
        } catch (error) {
            console.error('âŒ Firebase åˆå§‹åŒ–å¤±æ•—:', error);
            isFirebaseEnabled = false;
        }

        let players = []; // æ‰€æœ‰çƒå“¡
        let playerMatchCount = {}; // è¨˜éŒ„æ¯å€‹çƒå“¡å·²æ‰“çš„å ´æ¬¡
        let nextPlayerIndex = 0; // ä¸‹ä¸€å€‹æŒ‰é †åºä¸Šå ´çš„çƒå“¡ç´¢å¼•
        let currentCourtA = []; // ç•¶å‰çƒå ´Açš„çƒå“¡
        let currentCourtB = []; // ç•¶å‰çƒå ´Bçš„çƒå“¡
        let courtAFinished = false;
        let courtBFinished = false;
        let courtAStarted = false; // Aå ´æ˜¯å¦å·²å•Ÿç”¨é
        let courtBStarted = false; // Bå ´æ˜¯å¦å·²å•Ÿç”¨é
        let finishedMatches = 0;
        let deletedPlayers = {}; // è¨˜éŒ„åˆªé™¤çš„çƒå“¡åŠå…¶ä¸Šå ´æ¬¡æ•¸
        let pairHistory = {}; // è¨˜éŒ„çƒå“¡é…å°æ­·å² {playerA: {playerB: count, playerC: count}}
        let nextPlayers = []; // ä¸‹ä¸€è¼ªè¦ä¸Šå ´çš„4ä½çƒå“¡
        let nextPlayersNeedUpdate = true; // æ˜¯å¦éœ€è¦é‡æ–°è¨ˆç®—æº–å‚™ä¸Šå ´çƒå“¡

        // æ–°å¢ï¼šè¨˜éŒ„æ¯ä½çƒå“¡æœ€è¿‘ä¸€æ¬¡éšŠå‹åå–®
        let lastTeammates = {};

        // å¤šäººå”ä½œå„ªåŒ–ï¼šæ“ä½œé–å®šæ©Ÿåˆ¶
        let isOperating = false; // æ˜¯å¦æ­£åœ¨åŸ·è¡Œæ“ä½œ
        let isSyncing = false; // æ˜¯å¦æ­£åœ¨åŒæ­¥ä¸­
        let lastSyncTime = 0; // ä¸Šæ¬¡åŒæ­¥æ™‚é–“
        let localStateVersion = 0; // æœ¬åœ°ç‹€æ…‹ç‰ˆæœ¬è™Ÿ
        
        // å¸¸ç”¨åå–®
        let favoriteList = []; // å¸¸ç”¨çƒå“¡åå–®
        let selectedFavorites = []; // å‹¾é¸çš„å¸¸ç”¨çƒå“¡

        // nextPlayers ç”¢ç”Ÿé‚è¼¯çµ±ä¸€
        function getNextPlayers() {
            const onCourt = [...currentCourtA, ...currentCourtB];
            const waiting = players.filter(p => !onCourt.includes(p));
            
            if (waiting.length <= 4 && waiting.length > 0) {
                // ç­‰å€™å€â‰¤4äººï¼šå¾ç­‰å€™å€é¸ï¼ˆå·²æ‰“å ´æ¬¡æœ€å°‘ï¼‰+ å¾å‰›çµæŸæ¯”è³½çƒå ´è£œè¶³
                // å…ˆæ‰¾å‡ºç­‰å€™å€å·²æ‰“å ´æ¬¡æœ€å°‘çš„çƒå“¡
                let minCount = Math.min(...waiting.map(p => playerMatchCount[p] || 0));
                let minPlayers = waiting.filter(p => (playerMatchCount[p] || 0) === minCount);
                
                // å¾å·²æ‰“å ´æ¬¡æœ€å°‘çš„çƒå“¡ä¸­é¸äººï¼ˆæœ€å¤šé¸2äººï¼Œå¦‚æœç­‰å€™å€<2äººå‰‡å…¨é¸ï¼‰
                let selectedFromWaiting = [];
                const waitingSelectCount = Math.min(waiting.length, 2);
                
                if (minPlayers.length >= waitingSelectCount) {
                    // éš¨æ©Ÿé¸
                    selectedFromWaiting = [...minPlayers].sort(() => Math.random() - 0.5).slice(0, waitingSelectCount);
                } else {
                    // ä¸è¶³ï¼Œå…¨é¸å·²æ‰“æœ€å°‘çš„ï¼Œå†è£œå…¶ä»–
                    selectedFromWaiting = [...minPlayers];
                    let remaining = waiting.filter(p => !selectedFromWaiting.includes(p));
                    selectedFromWaiting.push(...remaining.slice(0, waitingSelectCount - selectedFromWaiting.length));
                }
                
                // å¾å‰›çµæŸæ¯”è³½çš„çƒå ´é¸äººè£œè¶³åˆ°4äºº
                let finishedPool = [];
                if (courtAFinished && currentCourtA.length > 0) {
                    finishedPool = [...currentCourtA];
                } else if (courtBFinished && currentCourtB.length > 0) {
                    finishedPool = [...currentCourtB];
                }
                
                // æ’é™¤å·²é¸çš„ç­‰å€™å€çƒå“¡ï¼Œéš¨æ©Ÿé¸äººè£œè¶³åˆ°4äºº
                finishedPool = finishedPool.filter(p => !selectedFromWaiting.includes(p));
                const needCount = 4 - selectedFromWaiting.length;
                let selectedFromFinished = [...finishedPool].sort(() => Math.random() - 0.5).slice(0, needCount);
                
                return [...selectedFromWaiting, ...selectedFromFinished];
            } else if (waiting.length === 0) {
                return [];
            } else {
                // ç­‰å€™å€>4äººï¼šå„ªå…ˆé¸å·²æ‰“0å ´çš„çƒå“¡
                const zeroMatchPlayers = waiting.filter(p => playerMatchCount[p] === 0);
                if (zeroMatchPlayers.length >= 4) {
                    return zeroMatchPlayers.slice(0, 4);
                } else {
                    const pool = waiting.filter(p => !zeroMatchPlayers.includes(p));
                    const shuffled = [...pool].sort(() => Math.random() - 0.5);
                    return [...zeroMatchPlayers, ...shuffled.slice(0, 4 - zeroMatchPlayers.length)];
                }
            }
        }

        // æ–°å¢çƒå“¡
        function addPlayer() {
            if (isOperating || isSyncing) {
                console.log('â³ æ“ä½œé€²è¡Œä¸­æˆ–åŒæ­¥ä¸­ï¼Œè«‹ç¨å€™...');
                return;
            }
            const input = document.getElementById('playerNameInput');
            let name = input.value.trim();
            name = name.replace(/\s+/g, '').replace(/[^\u4e00-\u9fa5A-Za-z0-9]/g, '');
            if (name.length > 0) {
                name = name[0].toUpperCase() + name.slice(1);
            }
            if (!name || name.length < 2 || name.length > 8) {
                alert('è«‹è¼¸å…¥2~8å­—çš„æœ‰æ•ˆå§“åï¼ˆç¦æ­¢ç‰¹æ®Šå­—å…ƒï¼‰');
                input.focus();
                return;
            }
            if (players.includes(name)) {
                alert('æ­¤å§“åå·²ç™»è¨˜ï¼');
                input.value = '';
                input.focus();
                return;
            }
            isOperating = true;
            input.disabled = true;
            players.push(name);
            playerMatchCount[name] = 0;
            pairHistory[name] = {};
            input.value = '';
            setTimeout(() => {
                input.disabled = false;
                input.focus();
                isOperating = false;
            }, 300);
            clearInputError();
            nextPlayersNeedUpdate = true;
            updateDisplay();
            saveToFirebase();
            autoStartIfReady();
        }

        // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
        function showInputError(msg) {
            alert(msg);
        }
        // æ¸…é™¤éŒ¯èª¤è¨Šæ¯
        function clearInputError() {
            const err = document.getElementById('inputErrorMsg');
            if (err) err.remove();
        }

        // è‡ªå‹•é–‹å§‹æ¯”è³½ï¼ˆæ»¿4äººæˆ–8äººï¼‰
        function autoStartIfReady() {
            // å„ªå…ˆæª¢æŸ¥æ˜¯å¦æœ‰å·²çµæŸçš„çƒå ´å¯ä»¥é‡æ–°é–‹å§‹
            if (courtAFinished) {
                autoReplaceCourtA();
                return;
            }
            if (courtBFinished) {
                autoReplaceCourtB();
                return;
            }
            // è¨ˆç®—ç›®å‰å ´ä¸Šäººæ•¸å’Œç­‰å€™å€äººæ•¸
            const onCourt = [...currentCourtA, ...currentCourtB].filter(p => p);
            const waiting = players.filter(p => !currentCourtA.includes(p) && !currentCourtB.includes(p));
            console.log('è‡ªå‹•æª¢æŸ¥ - ç¸½äººæ•¸:', players.length, 'å ´ä¸Š:', onCourt.length, 'ç­‰å€™:', waiting.length);
            // å¦‚æœç•¶å‰æ²’æœ‰æ¯”è³½é€²è¡Œä¸­ï¼Œä¸”è‡³å°‘æœ‰4äºº
            if (currentCourtA.length === 0 && currentCourtB.length === 0) {
                if (players.length >= 4) {
                    console.log('âœ… å•Ÿå‹•ç¬¬ä¸€å ´æ¯”è³½');
                    nextMatch();
                }
            }
            // å¦‚æœAå ´æœ‰æ¯”è³½ä½†Bå ´ç©ºè‘—ï¼Œä¸”ç­‰å€™å€æœ‰4äººä»¥ä¸Š
            else if (currentCourtA.length > 0 && currentCourtB.length === 0 && !courtAFinished) {
                if (waiting.length >= 4) {
                    console.log('âœ… å•Ÿå‹•Bå ´');
                    startCourtB();
                }
            }
        }

        // é–‹å§‹Bå ´
        function startCourtB() {
            const waiting = players.filter(p => !currentCourtA.includes(p) && !currentCourtB.includes(p));
            console.log('é–‹å§‹Bå ´ - ç­‰å€™å€çƒå“¡:', waiting);
            if (waiting.length >= 4) {
                if (nextPlayerIndex < players.length) {
                    const remaining = players.length - nextPlayerIndex;
                    if (remaining >= 4) {
                        currentCourtB = players.slice(nextPlayerIndex, nextPlayerIndex + 4);
                        nextPlayerIndex += 4;
                    } else {
                        currentCourtB = waiting.slice(0, 4);
                    }
                } else {
                    waiting.sort((a, b) => {
                        const countA = playerMatchCount[a] || 0;
                        const countB = playerMatchCount[b] || 0;
                        if (countA !== countB) return countA - countB;
                        return players.indexOf(a) - players.indexOf(b);
                    });
                    currentCourtB = waiting.slice(0, 4);
                }
                currentCourtB.forEach(p => playerMatchCount[p]++);
                courtBStarted = true;
                courtBFinished = false;
                console.log('âœ… Bå ´çƒå“¡:', currentCourtB);
                displayMatch();
                saveToFirebase();
            }
        }

        // æ›´æ–°é¡¯ç¤º
        function updateDisplay() {
            document.getElementById('totalPlayers').textContent = players.length;
            const currentPlayerCount = document.getElementById('currentPlayerCount');
            if (currentPlayerCount) {
                currentPlayerCount.textContent = `ğŸ‘¥ ç›®å‰å ±åäººæ•¸ ${players.length}äºº`;
            }
            const currentPlayerCountMobile = document.getElementById('currentPlayerCountMobile');
            if (currentPlayerCountMobile) {
                currentPlayerCountMobile.textContent = `ğŸ‘¥ ç›®å‰å ±åäººæ•¸ ${players.length}äºº`;
            }
            const playersList = document.getElementById('playersList');
            if (players.length > 0) {
                playersList.innerHTML = `
                    <div style="margin-top: 20px;">
                        <strong style="color: #667eea;">å·²ç™»è¨˜çƒå“¡ (${players.length}/16)</strong>
                        <div class="players-list" style="margin-top: 10px;">
                            ${players.map((name, idx) => 
                                `<div class="player-badge" style="display: flex; align-items: center; justify-content: space-between; gap: 6px;">
                                    <span>${idx + 1}. ${name}</span>
                                    <button onclick="deletePlayer('${name}')" title="åˆªé™¤" style="background: #dc3545; color: white; border: none; border-radius: 50%; width: 28px; height: 28px; font-size: 16px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center;">&#10006;</button>
                                </div>`
                            ).join('')}
                        </div>
                    </div>
                `;
            } else {
                playersList.innerHTML = '<div class="empty-state">å°šç„¡çƒå“¡ç™»è¨˜</div>';
            }
            const deletedList = document.getElementById('deletedPlayersList');
            if (deletedList) {
                if (Object.keys(deletedPlayers).length > 0) {
                    deletedList.innerHTML = `<div style='margin-top:10px;'>
                        <strong style='color:#dc3545;'>å·²åˆªé™¤çƒå“¡</strong>
                        <div style='display:grid;gap:8px;margin-top:8px;'>
                            ${Object.entries(deletedPlayers).map(([name, count]) =>
                                `<div style='background:#f8d7da;padding:8px;border-radius:6px;display:flex;align-items:center;justify-content:space-between;'>
                                    <span>${name}ï¼ˆå·²æ‰“${count}å ´ï¼‰</span>
                                    <button onclick="restorePlayer('${name}')" style='background:#28a745;color:white;border:none;border-radius:6px;padding:2px 10px;font-size:14px;cursor:pointer;'>æ¢å¾©</button>
                                </div>`
                            ).join('')}
                        </div>
                    </div>`;
                } else {
                    deletedList.innerHTML = '';
                }
            }
            const totalMatchCount = Object.values(playerMatchCount).reduce((a, b) => a + b, 0);
            const finishedCount = Math.floor(totalMatchCount / 4);
            document.getElementById('finishedMatches').textContent = finishedCount;
            updatePairingStats();
        }

        // é–‹å§‹ä¸‹ä¸€å ´æ¯”è³½
        function nextMatch() {
            courtAFinished = false;
            courtBFinished = false;
            currentCourtA = [];
            currentCourtB = [];
            
            // å¦‚æœé‚„æœ‰äººæŒ‰é †åºæ²’ä¸Šå ´éï¼Œå„ªå…ˆæŒ‰é †åºåˆ†é…
            if (nextPlayerIndex < players.length) {
                assignByOrder();
            } else {
                // æ‰€æœ‰äººéƒ½æŒ‰é †åºä¸Šéå ´äº†ï¼Œæ”¹ç”¨äº‚æ•¸é…å°
                assignByRandom();
            }
            
            displayMatch();
            saveToFirebase();
        }

        // æŒ‰é †åºåˆ†é…
        function assignByOrder() {
            const remaining = players.length - nextPlayerIndex;
            
            if (remaining >= 8) {
                // é‚„æœ‰8äººä»¥ä¸Šï¼Œé–‹å…©å ´
                currentCourtA = players.slice(nextPlayerIndex, nextPlayerIndex + 4);
                currentCourtB = players.slice(nextPlayerIndex + 4, nextPlayerIndex + 8);
                courtAStarted = true;
                courtBStarted = true;
                nextPlayerIndex += 8;
            } else if (remaining >= 4) {
                // é‚„æœ‰4-7äººï¼Œé–‹ä¸€å ´
                currentCourtA = players.slice(nextPlayerIndex, nextPlayerIndex + 4);
                courtAStarted = true;
                nextPlayerIndex += 4;
            } else {
                // ä¸è¶³4äººï¼Œæ··åˆäº‚æ•¸é…å°
                assignByRandom();
                return;
            }
            
            // æ›´æ–°å‡ºè³½æ¬¡æ•¸
            currentCourtA.forEach(p => playerMatchCount[p]++);
            currentCourtB.forEach(p => playerMatchCount[p]++);
        }

        // è¨ˆç®—é…å°å¤šæ¨£æ€§åˆ†æ•¸
        function getPairingScore(group) {
            let score = 0;
            for (let i = 0; i < group.length; i++) {
                for (let j = i + 1; j < group.length; j++) {
                    const p1 = group[i];
                    const p2 = group[j];
                    // æ‡²ç½°åˆ†ï¼šè‹¥ä¸Šæ¬¡å·²åŒçµ„ï¼Œé¡å¤–åŠ åˆ†
                    if (lastTeammates[p1] && lastTeammates[p1].includes(p2)) {
                        score += 100; // æœ€è¿‘åŒçµ„æ‡²ç½°åˆ†
                    }
                    // åŸæœ¬é…å°åˆ†æ•¸
                    score += (pairHistory[p1]?.[p2] || 0) * 2; // é…å°æ¬¡æ•¸è¶Šå¤šï¼Œæ‡²ç½°åˆ†è¶Šé«˜
                }
            }
            return score;
        }

        // äº‚æ•¸é…å°ï¼ˆé…å°å¤šæ¨£æ€§æ¼”ç®—æ³•ï¼Œé¿å…é‡è¤‡é…å°ï¼‰
        function assignByRandom() {
            const available = [...players];
            if (available.length < 4) {
                alert('çƒå“¡äººæ•¸ä¸è¶³4äººï¼Œç„¡æ³•é–‹å§‹æ¯”è³½ï¼');
                return;
            }
            
            // å¤šæ¨£æ€§é…å°ï¼šè©¦å¤šçµ„çµ„åˆï¼Œé¸æ“‡é…å°åˆ†æ•¸æœ€ä½çš„çµ„åˆ
            let bestCourtA = null, bestCourtB = null, bestScore = Infinity;
            const attempts = Math.min(100, 50); // å˜—è©¦50-100ç¨®çµ„åˆ
            
            for (let attempt = 0; attempt < attempts; attempt++) {
                const shuffled = [...available].sort(() => Math.random() - 0.5);
                const courtA = shuffled.slice(0, 4);
                const courtB = available.length >= 8 ? shuffled.slice(4, 8) : [];
                
                const scoreA = getPairingScore(courtA);
                const scoreB = courtB.length > 0 ? getPairingScore(courtB) : 0;
                const totalScore = scoreA + scoreB;
                
                if (totalScore < bestScore) {
                    bestScore = totalScore;
                    bestCourtA = courtA;
                    bestCourtB = courtB;
                }
            }
            
            currentCourtA = bestCourtA;
            currentCourtB = bestCourtB;
            courtAStarted = true;
            courtBStarted = currentCourtB.length > 0;
            
            // è¨˜éŒ„é…å°
            recordPairing(currentCourtA);
            recordPairing(currentCourtB);
            
            // æ›´æ–°å‡ºè³½æ¬¡æ•¸
            currentCourtA.forEach(p => playerMatchCount[p]++);
            currentCourtB.forEach(p => playerMatchCount[p]++);
        }
        
        // è¨˜éŒ„é…å°æ­·å²
        function recordPairing(court) {
            if (court.length < 2) return;
            for (let i = 0; i < court.length; i++) {
                for (let j = i + 1; j < court.length; j++) {
                    const p1 = court[i];
                    const p2 = court[j];
                    if (!pairHistory[p1]) pairHistory[p1] = {};
                    if (!pairHistory[p2]) pairHistory[p2] = {};
                    pairHistory[p1][p2] = (pairHistory[p1][p2] || 0) + 1;
                    pairHistory[p2][p1] = (pairHistory[p2][p1] || 0) + 1;
                }
            }
            // è¨˜éŒ„æœ€è¿‘ä¸€æ¬¡éšŠå‹
            court.forEach(p => {
                lastTeammates[p] = court.filter(x => x !== p);
            });
        }

        // é¡¯ç¤ºæ¯”è³½
        function displayMatch() {
            document.getElementById('currentMatch').style.display = 'block';
            
            const court1 = currentCourtA;
            const court2 = currentCourtB;
            
            // é¡¯ç¤ºçƒå ´
            let courtsHTML = '';
            
            // Aå ´ï¼šåªè¦æ›¾ç¶“å•Ÿç”¨éå°±ä¸€ç›´é¡¯ç¤º
            if (courtAStarted) {
                courtsHTML += `
                    <div class="court ${courtAFinished ? 'finished' : ''}">
                        <div class="court-title">ğŸ¸ çƒå ´ A</div>
                        <div class="court-players">
                            ${currentCourtA.length > 0 ? 
                                currentCourtA.map(p => 
                                    `<div class="player-item">${p} (ç¬¬${playerMatchCount[p]}å ´)</div>`
                                ).join('') : 
                                '<div style="text-align: center; color: #999; padding: 20px;">ç­‰å¾…çƒå“¡ä¸­...</div>'
                            }
                        </div>
                        ${!courtAFinished ? 
                            '<button class="btn btn-danger" onclick="finishCourt(\'A\')" style="width: 100%;">æ¯”è³½çµæŸï¼ˆè‡ªå‹•æ›¿è£œï¼‰</button>' : 
                            '<div style="text-align: center; color: #ff9800; font-weight: bold; padding: 10px; background: #fff3e0; border-radius: 5px;">â³ ç­‰å¾…ä¸­ï¼ˆéœ€è¦4åçƒå“¡ï¼‰</div>'
                        }
                    </div>
                `;
            }
            
            // Bå ´ï¼šåªè¦æ›¾ç¶“å•Ÿç”¨éå°±ä¸€ç›´é¡¯ç¤º
            if (courtBStarted) {
                courtsHTML += `
                    <div class="court ${courtBFinished ? 'finished' : ''}">
                        <div class="court-title">ğŸ¸ çƒå ´ B</div>
                        <div class="court-players">
                            ${currentCourtB.length > 0 ? 
                                currentCourtB.map(p => 
                                    `<div class="player-item">${p} (ç¬¬${playerMatchCount[p]}å ´)</div>`
                                ).join('') : 
                                '<div style="text-align: center; color: #999; padding: 20px;">ç­‰å¾…çƒå“¡ä¸­...</div>'
                            }
                        </div>
                        ${!courtBFinished ? 
                            '<button class="btn btn-danger" onclick="finishCourt(\'B\')" style="width: 100%;">æ¯”è³½çµæŸï¼ˆè‡ªå‹•æ›¿è£œï¼‰</button>' : 
                            '<div style="text-align: center; color: #ff9800; font-weight: bold; padding: 10px; background: #fff3e0; border-radius: 5px;">â³ ç­‰å¾…ä¸­ï¼ˆéœ€è¦4åçƒå“¡ï¼‰</div>'
                        }
                    </div>
                `;
            }
            
            document.getElementById('courtsContainer').innerHTML = courtsHTML;
            
            // æ›´æ–°å ´ä¸Šäººæ•¸å’Œç­‰å€™å€
            const onCourt = [...currentCourtA, ...currentCourtB];
            const waiting = players.filter(p => !onCourt.includes(p));
            
            document.getElementById('onCourtCount').textContent = onCourt.length;
            
            // åªåœ¨éœ€è¦æ›´æ–°æ™‚æ‰é‡æ–°è¨ˆç®—ä¸‹ä¸€è¼ªè¦ä¸Šå ´çš„4ä½çƒå“¡ï¼ˆä½¿ç”¨çµ±ä¸€çš„ getNextPlayers å‡½æ•¸ï¼‰
            if (nextPlayersNeedUpdate) {
                if (waiting.length > 0) {
                    // ä½¿ç”¨çµ±ä¸€çš„ getNextPlayers() å‡½æ•¸è¨ˆç®—
                    nextPlayers = getNextPlayers();
                    localStorage.setItem('nextPlayers', JSON.stringify(nextPlayers));
                    console.log('ğŸ’¾ æº–å‚™ä¸Šå ´çƒå“¡å·²å„²å­˜:', nextPlayers);
                    nextPlayersNeedUpdate = false;
                    // ç«‹å³åŒæ­¥åˆ° Firebaseï¼Œç¢ºä¿æ‰€æœ‰è£ç½®çœ‹åˆ°ç›¸åŒçš„ nextPlayers
                    saveToFirebase();
                } else {
                    // ç­‰å€™å€æ²’äºº
                    nextPlayers = [];
                    localStorage.removeItem('nextPlayers');
                    nextPlayersNeedUpdate = false;
                }
            }
            // ä¸éœ€è¦ else åˆ†æ”¯ï¼Œå› ç‚º Firebase åŒæ­¥æœƒè™•ç† nextPlayers çš„æ¢å¾©
            
            // æ›´æ–°ç­‰å€™å€
            const waitingBoxCard = document.getElementById('waitingBoxCard');
            if (waiting.length > 0) {
                waitingBoxCard.style.display = 'block';
                document.getElementById('waitingPlayers').innerHTML = waiting.map(p => {
                    const isNext = nextPlayers.includes(p);
                    return `<div class="waiting-player">${p}${isNext ? ` <span class="waiting-player-tag" style="cursor:pointer;" onclick="showReplaceDialog('${p}')">æº–å‚™ä¸Šå ´</span>` : ''}<br><small>å·²æ‰“${playerMatchCount[p]}å ´</small></div>`;
                }).join('');
            } else {
                waitingBoxCard.style.display = 'none';
            }
        }

        // æ¨™è¨˜çƒå ´çµæŸä¸¦è‡ªå‹•æ›¿è£œ
        function finishCourt(court) {
            if (isOperating || isSyncing) {
                console.log('â³ æ“ä½œé€²è¡Œä¸­æˆ–åŒæ­¥ä¸­ï¼Œè«‹ç¨å€™...');
                return;
            }
            isOperating = true;
            if (court === 'A') {
                courtAFinished = true;
                finishedMatches++;
                document.getElementById('finishedMatches').textContent = finishedMatches;
                localStorage.setItem('finishedMatches', finishedMatches);
                // Aå ´çµæŸï¼Œè‡ªå‹•æ›¿è£œ(æœƒè‡ªå‹•èª¿ç”¨saveToFirebase)
                autoReplaceCourtA();
                setTimeout(() => { isOperating = false; }, 500);
            } else if (court === 'B') {
                courtBFinished = true;
                finishedMatches++;
                document.getElementById('finishedMatches').textContent = finishedMatches;
                localStorage.setItem('finishedMatches', finishedMatches);
                // Bå ´çµæŸï¼Œè‡ªå‹•æ›¿è£œ(æœƒè‡ªå‹•èª¿ç”¨saveToFirebase)
                autoReplaceCourtB();
                setTimeout(() => { isOperating = false; }, 500);
            }
        }
        
        // è‡ªå‹•æ›¿è£œAå ´
        function autoReplaceCourtA() {
            // nextPlayers ç‚ºä¸»ï¼Œè£œè¶³ä¸è¶³æ‰ç”¨å‰›çµæŸæ¯”è³½çƒå“¡
            let prepared = nextPlayers ? nextPlayers.filter(p => !currentCourtB.includes(p)) : [];
            if (prepared.length < 4) {
                // è£œå‰›çµæŸæ¯”è³½çš„çƒå“¡ï¼ˆAå ´ï¼‰
                let finishedPool = [...currentCourtA].filter(p => !prepared.includes(p) && !currentCourtB.includes(p));
                prepared = [...prepared, ...finishedPool];
            }
            currentCourtA = prepared.slice(0, 4);
            recordPairing(currentCourtA);
            localStorage.removeItem('nextPlayers');
            nextPlayers = [];
            nextPlayersNeedUpdate = true;
            currentCourtA.forEach(p => playerMatchCount[p]++);
            courtAStarted = true;
            courtAFinished = false;
            displayMatch();
            saveToFirebase();
        }
        
        // è‡ªå‹•æ›¿è£œBå ´
        function autoReplaceCourtB() {
            // nextPlayers ç‚ºä¸»ï¼Œè£œè¶³ä¸è¶³æ‰ç”¨å‰›çµæŸæ¯”è³½çƒå“¡
            let prepared = nextPlayers ? nextPlayers.filter(p => !currentCourtA.includes(p)) : [];
            if (prepared.length < 4) {
                // è£œå‰›çµæŸæ¯”è³½çš„çƒå“¡ï¼ˆBå ´ï¼‰
                let finishedPool = [...currentCourtB].filter(p => !prepared.includes(p) && !currentCourtA.includes(p));
                prepared = [...prepared, ...finishedPool];
            }
            currentCourtB = prepared.slice(0, 4);
            recordPairing(currentCourtB);
            localStorage.removeItem('nextPlayers');
            nextPlayers = [];
            nextPlayersNeedUpdate = true;
            currentCourtB.forEach(p => playerMatchCount[p]++);
            courtBStarted = true;
            courtBFinished = false;
            displayMatch();
            saveToFirebase();
        }
        
        // Firebase å³æ™‚åŒæ­¥
        function startRealtimeSync() {
            if (!isFirebaseEnabled) return;
            
            unsubscribe = db.collection('badminton').doc('gameState').onSnapshot((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    const remoteVersion = data.version || 0;
                    
                    // ç‰ˆæœ¬æ¯”å°ï¼šåªæœ‰ç•¶é ç«¯ç‰ˆæœ¬æ›´æ–°æ™‚æ‰è¦†è“‹æœ¬åœ°è³‡æ–™
                    if (remoteVersion >= localStateVersion) {
                        players = data.players || [];
                        playerMatchCount = data.playerMatchCount || {};
                        nextPlayerIndex = data.nextPlayerIndex || 0;
                        currentCourtA = data.currentCourtA || [];
                        currentCourtB = data.currentCourtB || [];
                        courtAFinished = data.courtAFinished || false;
                        courtBFinished = data.courtBFinished || false;
                        courtAStarted = data.courtAStarted || false;
                        courtBStarted = data.courtBStarted || false;
                        finishedMatches = data.finishedMatches || 0;
                        localStateVersion = remoteVersion;
                        
                        // nextPlayers å¾ Firebase åŒæ­¥ï¼ˆä¿æŒç©©å®šæ€§ï¼‰
                        if (data.nextPlayers && data.nextPlayers.length > 0) {
                            const validNextPlayers = data.nextPlayers.filter(p => players.includes(p));
                            if (validNextPlayers.length === data.nextPlayers.length) {
                                nextPlayers = data.nextPlayers;
                                nextPlayersNeedUpdate = false;
                            } else {
                                nextPlayers = validNextPlayers;
                                nextPlayersNeedUpdate = true;
                            }
                        } else {
                            nextPlayers = [];
                            nextPlayersNeedUpdate = true;
                        }
                        
                        deletedPlayers = data.deletedPlayers || {};
                        
                        // åŒæ­¥å¸¸ç”¨åå–®
                        if (data.favoriteList) {
                            favoriteList = data.favoriteList;
                            refreshFavoriteList();
                            refreshMobileFavoriteList();
                        }
                        
                        updateDisplay();
                        
                        if (currentCourtA.length > 0 || currentCourtB.length > 0) {
                            const currentMatchDiv = document.getElementById('currentMatch');
                            if (currentMatchDiv) {
                                currentMatchDiv.style.display = 'block';
                            }
                            displayMatch();
                        }
                        console.log('ğŸ“¡ è³‡æ–™å·²åŒæ­¥ (ç‰ˆæœ¬: ' + remoteVersion + ')');
                        updateSyncStatus('âœ“ å·²åŒæ­¥');
                    }
                    lastSyncTime = Date.now();
                }
            }, (error) => {
                console.error('åŒæ­¥éŒ¯èª¤:', error);
                updateSyncStatus('âœ— é€£ç·šéŒ¯èª¤');
            });
        }
        
        // å„²å­˜åˆ° Firebaseï¼ˆnextPlayers ä¹ŸåŒæ­¥ï¼‰
        function saveToFirebase() {
            if (!isFirebaseEnabled) {
                console.log('æœ¬åœ°æ¨¡å¼ï¼šè³‡æ–™å·²æ›´æ–°');
                return;
            }
            isSyncing = true;
            updateSyncStatus('åŒæ­¥ä¸­...');
            localStateVersion++; // éå¢ç‰ˆæœ¬è™Ÿ
            const gameState = {
                players,
                playerMatchCount,
                nextPlayerIndex,
                currentCourtA,
                currentCourtB,
                courtAFinished,
                courtBFinished,
                courtAStarted,
                courtBStarted,
                finishedMatches,
                nextPlayers,
                deletedPlayers,
                favoriteList,
                version: localStateVersion, // æ–°å¢ç‰ˆæœ¬è™Ÿ
                lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
            };
            db.collection('badminton').doc('gameState').set(gameState)
                .then(() => {
                    console.log('ğŸ’¾ è³‡æ–™å·²å„²å­˜ (ç‰ˆæœ¬: ' + localStateVersion + ')');
                    isSyncing = false;
                    updateSyncStatus('âœ“ å·²åŒæ­¥');
                })
                .catch(error => {
                    console.error('å„²å­˜å¤±æ•—:', error);
                    isSyncing = false;
                    updateSyncStatus('âœ— åŒæ­¥å¤±æ•—');
                });
        }

        // æ›´æ–°åŒæ­¥ç‹€æ…‹æŒ‡ç¤ºå™¨
        function updateSyncStatus(message) {
            const statusEl = document.getElementById('syncStatus');
            if (statusEl) {
                statusEl.textContent = message;
                if (message.includes('âœ“')) {
                    setTimeout(() => { statusEl.textContent = ''; }, 2000);
                }
            }
        }

        // é‡ç½®æ¯”è³½
        function resetGame() {
            if (isOperating || isSyncing) {
                console.log('â³ æ“ä½œé€²è¡Œä¸­æˆ–åŒæ­¥ä¸­ï¼Œè«‹ç¨å€™...');
                return;
            }
            if (!confirm('ç¢ºå®šè¦é‡ç½®æ¯”è³½å—ï¼Ÿæ‰€æœ‰è³‡æ–™å°‡æœƒæ¸…ç©ºã€‚')) {
                return;
            }
            isOperating = true;
            
            // åªé‡è¨­ gameStateï¼Œä¸å½±éŸ¿å·²å„²å­˜çš„æ¯”è³½ç´€éŒ„ï¼ˆmatchRecordsã€calendarRecords å¦å­˜ï¼‰
            players = [];
            playerMatchCount = {};
            nextPlayerIndex = 0;
            currentCourtA = [];
            currentCourtB = [];
            courtAFinished = false;
            courtBFinished = false;
            courtAStarted = false;
            courtBStarted = false;
            finishedMatches = 0;
            nextPlayers = [];
            nextPlayersNeedUpdate = true;
            deletedPlayers = {};
            document.getElementById('currentMatch').style.display = 'none';
            document.getElementById('finishedMatches').textContent = '0';
            updateDisplay();
            // åªæ›´æ–° gameStateï¼Œä¸å‹• matchRecords/calendarRecords
            if (isFirebaseEnabled) {
                saveToFirebase();
            }
            setTimeout(() => { isOperating = false; }, 500);
        }

        // åˆªé™¤çƒå“¡å‡½å¼
        function deletePlayer(name) {
            if (isOperating || isSyncing) {
                console.log('â³ æ“ä½œé€²è¡Œä¸­æˆ–åŒæ­¥ä¸­ï¼Œè«‹ç¨å€™...');
                return;
            }
            // é˜²å‘†ï¼šåˆªé™¤å¾Œäººæ•¸ä¸è¶³4äººç¦æ­¢
            if (players.length <= 4) {
                alert('çƒå“¡äººæ•¸ä½æ–¼4äººï¼Œç„¡æ³•åˆªé™¤ï¼');
                return;
            }
            // é˜²å‘†ï¼šç¦æ­¢åˆªé™¤å ´ä¸Šæ­£åœ¨æ¯”è³½çš„çƒå“¡
            if (currentCourtA.includes(name) || currentCourtB.includes(name)) {
                alert('æ­¤çƒå“¡æ­£åœ¨æ¯”è³½ï¼Œè«‹å…ˆçµæŸæ¯”è³½å†åˆªé™¤ï¼');
                return;
            }
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${name}ã€å—ï¼Ÿ`)) return;
            isOperating = true;
            // è¨˜éŒ„åˆªé™¤å‰çš„ä¸Šå ´æ¬¡æ•¸
            deletedPlayers[name] = playerMatchCount[name] || 0;
            // å¾ players ç§»é™¤
            players = players.filter(p => p !== name);
            // å¾ playerMatchCount ç§»é™¤
            delete playerMatchCount[name];
            // å³æ™‚åŒæ­¥æ•´ç† nextPlayers åå–®
            if (nextPlayers.includes(name)) {
                nextPlayers = nextPlayers.filter(p => p !== name);
                if (nextPlayers.length === 0) {
                    localStorage.removeItem('nextPlayers');
                    nextPlayersNeedUpdate = true;
                } else {
                    localStorage.setItem('nextPlayers', JSON.stringify(nextPlayers));
                }
            }
            // æ›´æ–°é¡¯ç¤ºèˆ‡åŒæ­¥
            updateDisplay();
            saveToFirebase();
            setTimeout(() => { isOperating = false; }, 300);
        }

        // æ–°å¢ï¼šæ¢å¾©çƒå“¡å‡½å¼
        function restorePlayer(name) {
            if (players.includes(name)) {
                alert('æ­¤çƒå“¡å·²åœ¨åå–®ä¸­ï¼');
                return;
            }
            players.push(name);
            playerMatchCount[name] = deletedPlayers[name];
            delete deletedPlayers[name];
            updateDisplay();
            saveToFirebase();
        }

        // å½ˆå‡ºæ›¿æ›é¸å–®
function showReplaceDialog(oldPlayer) {
    // å–å¾—å¯æ›¿æ›åå–®ï¼ˆç­‰å€™å€ä¸”ä¸åœ¨ nextPlayersï¼‰
    const onCourt = [...currentCourtA, ...currentCourtB];
    const waiting = players.filter(p => !onCourt.includes(p));
    const candidates = waiting.filter(p => !nextPlayers.includes(p));
    if (candidates.length === 0) {
        alert('ç›®å‰æ²’æœ‰å¯æ›¿æ›çš„çƒå“¡');
        return;
    }
    // å»ºç«‹é¸å–®ï¼ˆradio + ç¢ºå®šæŒ‰éˆ•ï¼‰
    const selectHtml = `<div id='replaceDialogBg' style='position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.2);z-index:9999;' onclick='closeReplaceDialog()'></div>
        <div id='replaceDialog' style='position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:30px 24px;border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,0.18);z-index:10000;width:350px;'>
            <div style='font-weight:bold;font-size:18px;margin-bottom:12px;'>æ›¿æ›ã€Œ${oldPlayer}ã€</div>
            <div style='margin-bottom:16px;'>é¸æ“‡è¦æ›¿æ›é€²ä¾†çš„çƒå“¡ï¼š</div>
            <form id='replaceForm'>
                <div style='display:grid;gap:10px;margin-bottom:18px;'>
                    ${candidates.map(p => `<label style='display:flex;align-items:center;gap:8px;'><input type='radio' name='replaceCandidate' value='${p}'><span>${p}</span></label>`).join('')}
                </div>
                <button type='button' onclick="confirmReplaceNextPlayer('${oldPlayer}')" style='padding:10px 28px;border-radius:8px;border:none;background:#28a745;color:white;font-size:16px;cursor:pointer;'>ç¢ºå®š</button>
                <button type='button' onclick='closeReplaceDialog()' style='margin-left:12px;padding:8px 24px;border-radius:8px;border:none;background:#dc3545;color:white;font-size:15px;cursor:pointer;'>å–æ¶ˆ</button>
            </form>
        </div>`;
    const dialog = document.createElement('div');
    dialog.id = 'replaceDialogContainer';
    dialog.innerHTML = selectHtml;
    document.body.appendChild(dialog);
}

function closeReplaceDialog() {
    const dialog = document.getElementById('replaceDialogContainer');
    if (dialog) dialog.remove();
}

// ç¢ºèªæ›¿æ›ï¼ˆé»æ“Šç¢ºå®šæ‰åŸ·è¡Œï¼‰
function confirmReplaceNextPlayer(oldPlayer) {
    const form = document.getElementById('replaceForm');
    if (!form) return;
    const selectedRadio = form.querySelector('input[name="replaceCandidate"]:checked');
    if (!selectedRadio) {
        alert('è«‹é¸æ“‡è¦æ›¿æ›é€²ä¾†çš„çƒå“¡');
        return;
    }
    const newPlayer = selectedRadio.value;
    const idx = nextPlayers.indexOf(oldPlayer);
    if (idx === -1) {
        alert('åŸçƒå“¡ä¸åœ¨æº–å‚™ä¸Šå ´åå–®');
        closeReplaceDialog();
        return;
    }
    // æ‰‹å‹•æ›¿æ›ï¼šæ–°çƒå“¡æ’å…¥æœ€å‰é¢ï¼ŒèˆŠçƒå“¡ç§»é™¤ï¼Œå…¶ä»–é †åºä¸è®Š
    let newNextPlayers = nextPlayers.filter(p => p !== oldPlayer && p !== newPlayer);
    newNextPlayers.unshift(newPlayer);
    nextPlayers = newNextPlayers.slice(0, 4);
    localStorage.setItem('nextPlayers', JSON.stringify(nextPlayers));
    nextPlayersNeedUpdate = false;
    closeReplaceDialog();
    saveToFirebase(); // æ–°å¢ï¼šåŒæ­¥åˆ° Firebase
    updateDisplay(); // å³æ™‚æ›´æ–° UI
}

// æ›´æ–°é…å°çµ±è¨ˆé¡¯ç¤º
function updatePairingStats() {
    const statsCard = document.getElementById('pairingStats');
    if (players.length === 0) {
        statsCard.style.display = 'none';
        return;
    }
    statsCard.style.display = 'block';
    // å‡ºå ´æ¬¡æ•¸çµ±è¨ˆ
    const matchCountDiv = document.getElementById('matchCountStats');
    const counts = Object.entries(playerMatchCount).sort((a, b) => b[1] - a[1]);
    matchCountDiv.innerHTML = counts.map(([name, count]) => 
        `<div>${name}: ${count}å ´</div>`
    ).join('');
    // é…å°å¤šæ¨£æ€§åˆ†æ
    const diversityDiv = document.getElementById('pairingDiversityStats');
    let totalPairs = 0;
    let uniquePairs = 0;
    let maxPairCount = 0;
    Object.values(pairHistory).forEach(pairs => {
        Object.values(pairs).forEach(count => {
            totalPairs += count;
            uniquePairs++;
            if (count > maxPairCount) maxPairCount = count;
        });
    });
    diversityDiv.innerHTML = `
        <div>ç¸½é…å°æ¬¡æ•¸: ${totalPairs / 2}</div>
        <div>ä¸åŒé…å°çµ„åˆ: ${uniquePairs / 2}</div>
        <div>æœ€é«˜é‡è¤‡é…å°: ${maxPairCount}æ¬¡</div>
    `;
}

// è‡ªå‹•æ¸¬è©¦é…å°æ¼”ç®—æ³•
// ...è‡ªå‹•æ¸¬è©¦é…å°æ¼”ç®—æ³•åŠŸèƒ½å·²ç§»é™¤...
        // æ‰‹æ©Ÿç‰ˆé¢æ¿æ§åˆ¶
        function toggleMobilePanel() {
            const panel = document.getElementById('mobileAddPlayerPanel');
            const overlay = document.getElementById('mobilePanelOverlay');
            if (panel.classList.contains('active')) {
                closeMobilePanel();
            } else {
                panel.style.display = 'block';
                overlay.style.display = 'block';
                setTimeout(() => {
                    panel.classList.add('active');
                }, 10);
                document.getElementById('playerNameInputMobile').focus();
            }
        }

        function closeMobilePanel() {
            const panel = document.getElementById('mobileAddPlayerPanel');
            const overlay = document.getElementById('mobilePanelOverlay');
            panel.classList.remove('active');
            setTimeout(() => {
                panel.style.display = 'none';
                overlay.style.display = 'none';
            }, 300);
        }

        // æ‰‹æ©Ÿç‰ˆå¸¸ç”¨åå–®é¢æ¿æ§åˆ¶
        function toggleMobileFavoritePanel() {
            const panel = document.getElementById('mobileFavoritePanel');
            const overlay = document.getElementById('mobileFavoritePanelOverlay');
            if (panel.classList.contains('active')) {
                closeMobileFavoritePanel();
            } else {
                panel.style.display = 'block';
                overlay.style.display = 'block';
                setTimeout(() => {
                    panel.classList.add('active');
                }, 10);
                refreshMobileFavoriteList();
            }
        }

        function closeMobileFavoritePanel() {
            const panel = document.getElementById('mobileFavoritePanel');
            const overlay = document.getElementById('mobileFavoritePanelOverlay');
            panel.classList.remove('active');
            setTimeout(() => {
                panel.style.display = 'none';
                overlay.style.display = 'none';
            }, 300);
        }

        // æ‰‹æ©Ÿç‰ˆæ–°å¢çƒå“¡
        function addPlayerMobile() {
            if (isOperating || isSyncing) {
                console.log('â³ æ“ä½œé€²è¡Œä¸­æˆ–åŒæ­¥ä¸­ï¼Œè«‹ç¨å€™...');
                return;
            }
            const input = document.getElementById('playerNameInputMobile');
            let name = input.value.trim();
            name = name.replace(/\s+/g, '').replace(/[^\u4e00-\u9fa5A-Za-z0-9]/g, '');
            if (name.length > 0) {
                name = name[0].toUpperCase() + name.slice(1);
            }
            if (!name || name.length < 2 || name.length > 8) {
                alert('è«‹è¼¸å…¥2~8å­—çš„æœ‰æ•ˆå§“åï¼ˆç¦æ­¢ç‰¹æ®Šå­—å…ƒï¼‰');
                input.focus();
                return;
            }
            if (players.includes(name)) {
                alert('æ­¤å§“åå·²ç™»è¨˜ï¼');
                input.value = '';
                input.focus();
                return;
            }
            isOperating = true;
            input.disabled = true;
            players.push(name);
            playerMatchCount[name] = 0;
            pairHistory[name] = {};
            input.value = '';
            setTimeout(() => {
                input.disabled = false;
                input.focus();
                isOperating = false;
            }, 300);
            nextPlayersNeedUpdate = true;
            updateDisplay();
            saveToFirebase();
            autoStartIfReady();
            closeMobilePanel();
        }

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        window.onload = function() {
            // è®€å– finishedMatches
            const storedFinished = localStorage.getItem('finishedMatches');
            if (storedFinished) {
                finishedMatches = parseInt(storedFinished, 10) || 0;
                document.getElementById('finishedMatches').textContent = finishedMatches;
            }
            // å¸¸ç”¨åå–®å¾ Firebase åŒæ­¥ï¼Œä¸å†ä½¿ç”¨ localStorage
            // deletedPlayers åªèµ° Firebaseï¼Œä¸å†è®€ localStorage
            updateDisplay();
            updatePairingStats();
            refreshFavoriteList();
            refreshMobileFavoriteList();
        };
        
        // æ¯”è³½ç´€éŒ„å„²å­˜æ–¼ localStorageï¼Œæ ¼å¼ï¼š{ date: { players: [...], matchCount: {...} } }
        function saveMatchRecord() {
            if (players.length === 0 && Object.keys(deletedPlayers).length === 0) {
                alert('ç›®å‰æ²’æœ‰çƒå“¡ï¼Œç„¡æ³•å„²å­˜æ¯”è³½ï¼');
                return;
            }
            const today = new Date();
            const dateStr = today.getFullYear() + '-' + String(today.getMonth()+1).padStart(2,'0') + '-' + String(today.getDate()).padStart(2,'0');
            if (!confirm(`ç¢ºå®šè¦å„²å­˜ ${dateStr} çš„æ¯”è³½ç´€éŒ„å—ï¼Ÿ`)) {
                return;
            }
            // åˆä½µç¾æœ‰çƒå“¡èˆ‡å·²åˆªé™¤çƒå“¡
            const allNames = [...players, ...Object.keys(deletedPlayers)];
            // åˆä½µå ´æ¬¡
            const matchCountAll = {...playerMatchCount};
            Object.entries(deletedPlayers).forEach(([name, count]) => {
                matchCountAll[name] = count;
            });
            const record = {
                date: dateStr,
                players: allNames,
                matchCount: matchCountAll,
                deleted: Object.keys(deletedPlayers)
            };
            let allRecords = JSON.parse(localStorage.getItem('matchRecords') || '{}');
            allRecords[dateStr] = record;
            localStorage.setItem('matchRecords', JSON.stringify(allRecords));
            alert('æ¯”è³½ç´€éŒ„å·²ä¿å­˜ï¼');
            showMatchRecordModal(record);
        }

        function showMatchRecordModal(record) {
            const modal = document.getElementById('matchRecordModal');
            const tableDiv = document.getElementById('matchRecordTable');
            if (!record) {
                tableDiv.innerHTML = '<div style="color:#dc3545;">æŸ¥ç„¡ç´€éŒ„</div>';
            } else {
                let html = `<div style="margin-bottom:16px;font-size:18px;font-weight:bold;color:#667eea;">ğŸ“… æ—¥æœŸï¼š${record.date}</div>`;
                html += '<table style="width:100%;border-collapse:collapse;font-size:16px;">';
                html += '<tr style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:white;"><th style="padding:12px;text-align:left;">çƒå“¡å§“å</th><th style="padding:12px;text-align:center;">æ‰“å¹¾å ´</th></tr>';
                record.players.forEach((name, idx) => {
                    const isDel = record.deleted && record.deleted.includes(name);
                    const bgColor = idx % 2 === 0 ? '#f9f9f9' : '#ffffff';
                    html += `<tr style="background:${bgColor};border-bottom:1px solid #e0e0e0;${isDel ? 'opacity:0.6;' : ''}"><td style="padding:12px;${isDel ? 'text-decoration:line-through;color:#999;' : 'color:#333;'}">${name}${isDel ? ' <span style=\'color:#dc3545;font-size:12px;font-weight:bold;\'>(å·²åˆªé™¤)</span>' : ''}</td><td style="padding:12px;text-align:center;font-weight:bold;color:#667eea;">${record.matchCount[name] || 0}</td></tr>`;
                });
                html += '</table>';
                html += `<div style="margin-top:16px;text-align:center;"><button style="background:#667eea;color:white;padding:10px 20px;border:none;border-radius:8px;font-size:16px;cursor:pointer;font-weight:bold;" onclick="closeMatchRecordModal()">âœ• é—œé–‰</button></div>`;
                tableDiv.innerHTML = html;
            }
            modal.style.display = 'block';
        }

        function closeMatchRecordModal() {
            document.getElementById('matchRecordModal').style.display = 'none';
        }

        function showMatchCalendar() {
            const modal = document.getElementById('matchCalendarModal');
            const dateListDiv = document.getElementById('calendarDateList');
            const tableDiv = document.getElementById('calendarRecordTable');
            let allRecords = JSON.parse(localStorage.getItem('matchRecords') || '{}');
            const dates = Object.keys(allRecords).sort((a,b) => b.localeCompare(a));
            if (dates.length === 0) {
                dateListDiv.innerHTML = '<div style="color:#dc3545;">å°šç„¡æ¯”è³½ç´€éŒ„</div>';
                tableDiv.innerHTML = '';
            } else {
                dateListDiv.innerHTML = dates.map(date => `<button style="margin:4px 8px 4px 0;padding:8px 18px;border-radius:8px;border:none;background:#667eea;color:white;font-size:16px;cursor:pointer;" onclick="showCalendarRecord('${date}')">${date}</button>`).join('');
                tableDiv.innerHTML = '';
            }
            modal.style.display = 'block';
        }

        function showCalendarRecord(date) {
            let allRecords = JSON.parse(localStorage.getItem('matchRecords') || '{}');
            const record = allRecords[date];
            const tableDiv = document.getElementById('calendarRecordTable');
            if (!record) {
                tableDiv.innerHTML = '<div style="color:#dc3545;">æŸ¥ç„¡ç´€éŒ„</div>';
            } else {
                let html = `<div style="margin-bottom:16px;font-size:18px;font-weight:bold;color:#667eea;">ğŸ“… æ—¥æœŸï¼š${record.date}</div>`;
                html += '<table style="width:100%;border-collapse:collapse;font-size:16px;">';
                html += '<tr style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:white;"><th style="padding:12px;text-align:left;">çƒå“¡å§“å</th><th style="padding:12px;text-align:center;">æ‰“å¹¾å ´</th></tr>';
                record.players.forEach((name, idx) => {
                    const isDel = record.deleted && record.deleted.includes(name);
                    const bgColor = idx % 2 === 0 ? '#f9f9f9' : '#ffffff';
                    html += `<tr style="background:${bgColor};border-bottom:1px solid #e0e0e0;${isDel ? 'opacity:0.6;' : ''}"><td style="padding:12px;${isDel ? 'text-decoration:line-through;color:#999;' : 'color:#333;'}">${name}${isDel ? ' <span style=\'color:#dc3545;font-size:12px;font-weight:bold;\'>(å·²åˆªé™¤)</span>' : ''}</td><td style="padding:12px;text-align:center;font-weight:bold;color:#667eea;">${record.matchCount[name] || 0}</td></tr>`;
                });
                html += '</table>';
                html += `<div style="margin-top:16px;display:flex;gap:10px;justify-content:center;"><button style="background:#dc3545;color:white;padding:10px 20px;border:none;border-radius:8px;font-size:16px;cursor:pointer;font-weight:bold;" onclick="deleteMatchRecord('${date}')">ğŸ—‘ï¸ åˆªé™¤æ­¤ç´€éŒ„</button><button style="background:#667eea;color:white;padding:10px 20px;border:none;border-radius:8px;font-size:16px;cursor:pointer;font-weight:bold;" onclick="closeMatchCalendarModal()">âœ• é—œé–‰</button></div>`;
                tableDiv.innerHTML = html;
            }
        }

        function deleteMatchRecord(date) {
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤ ${date} çš„æ¯”è³½ç´€éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ¢å¾©ã€‚`)) {
                return;
            }
            let allRecords = JSON.parse(localStorage.getItem('matchRecords') || '{}');
            delete allRecords[date];
            localStorage.setItem('matchRecords', JSON.stringify(allRecords));
            alert(`${date} çš„æ¯”è³½ç´€éŒ„å·²åˆªé™¤ã€‚`);
            // é‡æ–°åˆ·æ–°æ—¥æ›†åˆ—è¡¨
            showMatchCalendar();
        }

        function closeMatchCalendarModal() {
            document.getElementById('matchCalendarModal').style.display = 'none';
        }

        // å¸¸ç”¨åå–®ç®¡ç†
        function toggleFavoriteList() {
            const panel = document.getElementById('favoriteListPanel');
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                refreshFavoriteList();
            } else {
                panel.style.display = 'none';
            }
        }

        function refreshFavoriteList() {
            const listDiv = document.getElementById('favoritePlayersList');
            if (favoriteList.length === 0) {
                listDiv.innerHTML = '<div style="color:#999;font-size:14px;">å°šæœªæ–°å¢å¸¸ç”¨çƒå“¡</div>';
            } else {
                listDiv.innerHTML = favoriteList.map((name, idx) => `
                    <div style="display:flex;align-items:center;gap:8px;background:white;padding:8px 12px;border-radius:6px;border-left:3px solid #667eea;">
                        <input type="checkbox" id="fav-${idx}" onchange="toggleFavoriteCheckbox(${idx})" style="width:18px;height:18px;cursor:pointer;">
                        <span style="flex:1;">${name}</span>
                        <button class="btn btn-danger" style="padding:4px 12px;font-size:16px;" onclick="removeFavoritePlayer(${idx})">X</button>
                    </div>
                `).join('');
            }
        }

        function toggleFavoriteCheckbox(idx) {
            const checkbox = document.getElementById(`fav-${idx}`);
            if (checkbox.checked) {
                if (!selectedFavorites.includes(favoriteList[idx])) {
                    selectedFavorites.push(favoriteList[idx]);
                }
            } else {
                selectedFavorites = selectedFavorites.filter(name => name !== favoriteList[idx]);
            }
        }

        function addFavoritePlayer() {
            const input = document.getElementById('newFavoriteName');
            let name = input.value.trim();
            name = name.replace(/\s+/g, '').replace(/[^\u4e00-\u9fa5A-Za-z0-9]/g, '');
            if (name.length > 0) {
                name = name[0].toUpperCase() + name.slice(1);
            }
            if (!name || name.length < 2 || name.length > 8) {
                alert('è«‹è¼¸å…¥2~8å­—çš„æœ‰æ•ˆå§“åï¼ˆç¦æ­¢ç‰¹æ®Šå­—å…ƒï¼‰');
                input.focus();
                return;
            }
            if (favoriteList.includes(name)) {
                alert('æ­¤å§“åå·²åœ¨å¸¸ç”¨åå–®ä¸­ï¼');
                input.value = '';
                return;
            }
            favoriteList.push(name);
            input.value = '';
            saveToFirebase();
            refreshFavoriteList();
            refreshMobileFavoriteList();
        }

        function removeFavoritePlayer(idx) {
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${favoriteList[idx]}ã€å—ï¼Ÿ`)) return;
            favoriteList.splice(idx, 1);
            saveToFirebase();
            refreshFavoriteList();
            refreshMobileFavoriteList();
        }

        function quickAddPlayer(name) {
            if (isOperating || isSyncing) {
                console.log('â³ æ“ä½œé€²è¡Œä¸­æˆ–åŒæ­¥ä¸­ï¼Œè«‹ç¨å€™...');
                return;
            }
            if (players.includes(name)) {
                alert('æ­¤å§“åå·²ç™»è¨˜ï¼');
                return;
            }
            isOperating = true;
            players.push(name);
            playerMatchCount[name] = 0;
            pairHistory[name] = {};
            nextPlayersNeedUpdate = true;
            setTimeout(() => {
                isOperating = false;
            }, 300);
            updateDisplay();
            saveToFirebase();
            autoStartIfReady();
            // é—œé–‰å¸¸ç”¨åå–®é¢æ¿
            document.getElementById('favoriteListPanel').style.display = 'none';
        }

        function addSelectedFavorites() {
            if (selectedFavorites.length === 0) {
                alert('è«‹å…ˆå‹¾é¸è¦æ–°å¢çš„çƒå“¡');
                return;
            }
            if (isOperating || isSyncing) {
                console.log('â³ æ“ä½œé€²è¡Œä¸­æˆ–åŒæ­¥ä¸­ï¼Œè«‹ç¨å€™...');
                return;
            }
            const notAddedPlayers = selectedFavorites.filter(name => !players.includes(name));
            if (notAddedPlayers.length === 0) {
                alert('å‹¾é¸çš„çƒå“¡éƒ½å·²ç™»è¨˜ï¼');
                return;
            }
            isOperating = true;
            notAddedPlayers.forEach(name => {
                players.push(name);
                playerMatchCount[name] = 0;
                pairHistory[name] = {};
            });
            nextPlayersNeedUpdate = true;
            setTimeout(() => {
                isOperating = false;
            }, 300);
            updateDisplay();
            saveToFirebase();
            autoStartIfReady();
            // æ¸…ç©ºå‹¾é¸ç‹€æ…‹
            selectedFavorites = [];
            // é—œé–‰å¸¸ç”¨åå–®é¢æ¿
            document.getElementById('favoriteListPanel').style.display = 'none';
            alert(`å·²æ–°å¢ ${notAddedPlayers.length} ä½çƒå“¡`);
        }

        // æ‰‹æ©Ÿç‰ˆå¸¸ç”¨åå–®
        function toggleMobileFavoriteList() {
            const panel = document.getElementById('mobileFavoriteListPanel');
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                refreshMobileFavoriteList();
            } else {
                panel.style.display = 'none';
            }
        }

        function refreshMobileFavoriteList() {
            const listDiv = document.getElementById('mobileFavoritePlayersList');
            if (favoriteList.length === 0) {
                listDiv.innerHTML = '<div style="color:#999;font-size:16px;">å°šæœªæ–°å¢å¸¸ç”¨çƒå“¡</div>';
            } else {
                listDiv.innerHTML = favoriteList.map((name, idx) => `
                    <div style="display:flex;align-items:center;gap:6px;background:white;padding:10px;border-radius:6px;border-left:3px solid #667eea;">
                        <input type="checkbox" id="fav-mobile-${idx}" onchange="toggleMobileFavoriteCheckbox(${idx})" style="width:16px;height:16px;cursor:pointer;">
                        <span style="flex:1;font-size:16px;">${name}</span>
                    </div>
                `).join('');
            }
        }

        function toggleMobileFavoriteCheckbox(idx) {
            const checkbox = document.getElementById(`fav-mobile-${idx}`);
            if (checkbox.checked) {
                if (!selectedFavorites.includes(favoriteList[idx])) {
                    selectedFavorites.push(favoriteList[idx]);
                }
            } else {
                selectedFavorites = selectedFavorites.filter(name => name !== favoriteList[idx]);
            }
        }

        function addSelectedFavoritesMobile() {
            if (selectedFavorites.length === 0) {
                alert('è«‹å…ˆå‹¾é¸è¦æ–°å¢çš„çƒå“¡');
                return;
            }
            if (isOperating || isSyncing) {
                console.log('â³ æ“ä½œé€²è¡Œä¸­æˆ–åŒæ­¥ä¸­ï¼Œè«‹ç¨å€™...');
                return;
            }
            const notAddedPlayers = selectedFavorites.filter(name => !players.includes(name));
            if (notAddedPlayers.length === 0) {
                alert('å‹¾é¸çš„çƒå“¡éƒ½å·²ç™»è¨˜ï¼');
                return;
            }
            isOperating = true;
            notAddedPlayers.forEach(name => {
                players.push(name);
                playerMatchCount[name] = 0;
                pairHistory[name] = {};
            });
            nextPlayersNeedUpdate = true;
            setTimeout(() => {
                isOperating = false;
            }, 300);
            updateDisplay();
            saveToFirebase();
            autoStartIfReady();
            // æ¸…ç©ºå‹¾é¸ç‹€æ…‹
            selectedFavorites = [];
            // é—œé–‰å¸¸ç”¨åå–®é¢æ¿
            closeMobileFavoritePanel();
            alert(`å·²æ–°å¢ ${notAddedPlayers.length} ä½çƒå“¡`);
        }

        function addFavoritePlayerMobile() {
            const input = document.getElementById('newFavoriteNameMobile');
            let name = input.value.trim();
            name = name.replace(/\s+/g, '').replace(/[^\u4e00-\u9fa5A-Za-z0-9]/g, '');
            if (name.length > 0) {
                name = name[0].toUpperCase() + name.slice(1);
            }
            if (!name || name.length < 2 || name.length > 8) {
                alert('è«‹è¼¸å…¥2~8å­—çš„æœ‰æ•ˆå§“åï¼ˆç¦æ­¢ç‰¹æ®Šå­—å…ƒï¼‰');
                input.focus();
                return;
            }
            if (favoriteList.includes(name)) {
                alert('æ­¤å§“åå·²åœ¨å¸¸ç”¨åå–®ä¸­ï¼');
                input.value = '';
                return;
            }
            favoriteList.push(name);
            input.value = '';
            saveToFirebase();
            refreshFavoriteList();
            refreshMobileFavoriteList();
        }
    </script>
</body>
</html>